<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 to-red-50 min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="text-6xl mb-4">‚è≥</div>
                <p class="text-gray-600">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        function waitForSupabase() {
            if (typeof window.supabase !== 'undefined') {
                startApp();
            } else {
                setTimeout(waitForSupabase, 100);
            }
        }
        waitForSupabase();

        function startApp() {
            // Configure PDF.js worker
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }

            const SUPABASE_URL = 'https://cmefgdiltjevddraguso.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtZWZnZGlsdGpldmRkcmFndXNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjg5NzAsImV4cCI6MjA3NDk0NDk3MH0.Cz3Acd0Qy5UR_bItqLSSn0zLoLtvvqu1WPG77-PM1RM';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            const AI_API_URL = 'https://api.euron.one/api/v1/euri/chat/completions';
            const AI_API_KEY = 'euri-806e518a3ad06e4491c2b099282bf8de3fef780b9ed1abde986b954a3c95dad6';

            let currentUser = null;
            let currentUserData = null;

            initAuth();

            async function initAuth() {
                try {
                    const sessionPromise = supabase.auth.getSession();
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), 5000)
                    );
                    
                    const { data: { session } } = await Promise.race([sessionPromise, timeoutPromise]);
                    
                    if (session) {
                        currentUser = session.user;
                        await loadUserData();
                        
                        if (currentUserData) {
                            if (currentUserData.role === 'uncle') {
                                showUncleDashboard();
                            } else if (currentUserData.role === 'agent') {
                                showAgentPortal();
                            }
                        } else {
                            showLoginPage();
                        }
                    } else {
                        showLoginPage();
                    }
                } catch (error) {
                    showLoginPage();
                }

                supabase.auth.onAuthStateChange(async (event) => {
                    if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                        window.location.reload();
                    }
                });
            }

            async function loadUserData() {
                try {
                    const { data, error } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();
                    if (error) throw error;
                    currentUserData = data;
                } catch (error) {
                    currentUserData = null;
                }
            }

            function showLoginPage() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border-4 border-orange-400">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4">üëë</div>
                                <h1 class="text-3xl font-bold text-gray-800">VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä</h1>
                                <p class="text-gray-600 mt-2">‡∞µ‡±É‡∞§‡±ç‡∞§‡∞ø‡∞™‡∞∞‡∞Æ‡±à‡∞® ‡∞™‡±Ü‡∞≥‡±ç‡∞≤‡∞ø‡∞ï‡±Ç‡∞§‡±Å‡∞∞ ‡∞µ‡±ç‡∞Ø‡∞µ‡∞∏‡±ç‡∞•</p>
                            </div>
                            
                            <form id="loginForm" class="space-y-4">
                                <input type="email" id="loginEmail" required placeholder="‡∞á‡∞Æ‡±Ü‡∞Ø‡∞ø‡∞≤‡±ç"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none" />
                                <input type="password" id="loginPassword" required placeholder="‡∞™‡∞æ‡∞∏‡±ç‡∞µ‡∞∞‡±ç‡∞°‡±ç"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none" />
                                <button type="submit"
                                    class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-3 rounded-lg font-semibold">
                                    ‡∞≤‡∞æ‡∞ó‡∞ø‡∞®‡±ç
                                </button>
                            </form>
                            
                            <div id="loginError" class="mt-4 hidden">
                                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                            </div>

                            <div class="mt-6 p-4 bg-gray-50 rounded-lg text-xs text-gray-600">
                                <p class="font-semibold mb-2">‡∞ü‡±Ü‡∞∏‡±ç‡∞ü‡±ç ‡∞ï‡±ç‡∞∞‡±Ü‡∞°‡±Ü‡∞®‡±ç‡∞∑‡∞ø‡∞Ø‡∞≤‡±ç‡∞∏‡±ç:</p>
                                <p>‡∞Ö‡∞Ç‡∞ï‡±Å‡∞≤‡±ç: uncle@reddy.com / reddy2025</p>
                                <p>‡∞è‡∞ú‡±Ü‡∞Ç‡∞ü‡±ç: agent@reddy.com / agent123</p>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    const errorDiv = document.getElementById('loginError');

                    try {
                        const { error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    } catch (error) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.querySelector('div').textContent = error.message;
                    }
                });
            }

            function showPhotoGallery(photos, name, startIndex = 0) {
                let currentIndex = startIndex;
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-95 flex z-50';
                modal.innerHTML = `
                    <div class="flex w-full h-full">
                        <div class="w-32 bg-gray-900 p-2 overflow-y-auto">
                            <div class="text-white text-sm mb-2 text-center">‡∞´‡±ã‡∞ü‡±ã‡∞≤‡±Å (${photos.length})</div>
                            ${photos.map((photo, idx) => `
                                <img src="${photo}" 
                                     data-index="${idx}"
                                     class="thumbnail w-full h-24 object-cover rounded mb-2 cursor-pointer border-2 ${idx === currentIndex ? 'border-blue-500' : 'border-transparent'} hover:border-blue-300"
                                     alt="Photo ${idx + 1}" />
                            `).join('')}
                        </div>
                        
                        <div class="flex-1 relative flex items-center justify-center p-8">
                            <button class="close-btn absolute top-4 right-4 bg-white rounded-full w-12 h-12 flex items-center justify-center text-2xl hover:bg-gray-200 z-10">
                                √ó
                            </button>
                            
                            ${photos.length > 1 ? `
                                <button class="prev-btn absolute left-4 bg-white rounded-full w-12 h-12 flex items-center justify-center text-2xl hover:bg-gray-200">
                                    ‚Äπ
                                </button>
                                <button class="next-btn absolute right-4 bg-white rounded-full w-12 h-12 flex items-center justify-center text-2xl hover:bg-gray-200">
                                    ‚Ä∫
                                </button>
                            ` : ''}
                            
                            <div class="text-center max-w-5xl max-h-full">
                                <h3 class="text-white text-2xl font-bold mb-4">${name}</h3>
                                <img src="${photos[currentIndex]}" 
                                     class="main-photo max-w-full max-h-[80vh] mx-auto rounded-lg shadow-2xl" 
                                     alt="${name}" />
                                <p class="text-white mt-4 text-lg">‡∞´‡±ã‡∞ü‡±ã ${currentIndex + 1} / ${photos.length}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);

                const mainPhoto = modal.querySelector('.main-photo');
                const counter = modal.querySelector('p');
                const thumbnails = modal.querySelectorAll('.thumbnail');

                function updatePhoto(index) {
                    currentIndex = index;
                    mainPhoto.src = photos[index];
                    counter.textContent = `‡∞´‡±ã‡∞ü‡±ã ${index + 1} / ${photos.length}`;
                    
                    thumbnails.forEach((thumb, idx) => {
                        thumb.classList.toggle('border-blue-500', idx === index);
                        thumb.classList.toggle('border-transparent', idx !== index);
                    });
                }

                thumbnails.forEach(thumb => {
                    thumb.addEventListener('click', () => {
                        updatePhoto(parseInt(thumb.dataset.index));
                    });
                });

                const prevBtn = modal.querySelector('.prev-btn');
                const nextBtn = modal.querySelector('.next-btn');
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        updatePhoto((currentIndex - 1 + photos.length) % photos.length);
                    });
                }
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        updatePhoto((currentIndex + 1) % photos.length);
                    });
                }

                modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });

                document.addEventListener('keydown', function handleKeyPress(e) {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', handleKeyPress);
                    } else if (e.key === 'ArrowLeft' && photos.length > 1) {
                        updatePhoto((currentIndex - 1 + photos.length) % photos.length);
                    } else if (e.key === 'ArrowRight' && photos.length > 1) {
                        updatePhoto((currentIndex + 1) % photos.length);
                    }
                });
            }

            window.showPhotoGalleryGlobal = showPhotoGallery;

            function showUncleDashboard() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen p-6">
                        <div class="max-w-7xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-3xl font-bold">‡∞Ö‡∞Ç‡∞ï‡±Å‡∞≤‡±ç ‡∞°‡∞æ‡∞∑‡±ç‡∞¨‡±ã‡∞∞‡±ç‡∞°‡±ç</h1>
                                        <p class="text-gray-600">‡∞∏‡±ç‡∞µ‡∞æ‡∞ó‡∞§‡∞Ç, ${currentUserData.name}</p>
                                    </div>
                                    <div class="flex gap-4">
                                        <button onclick="showMatchingView()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                            ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡∞ø‡∞Ç‡∞ó‡±ç
                                        </button>
                                        <button id="logoutBtn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                            ‡∞≤‡∞æ‡∞ó‡±ç‡∞Ö‡∞µ‡±Å‡∞ü‡±ç
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                                <div class="bg-blue-500 text-white rounded-xl p-6">
                                    <div class="text-4xl mb-2">üìä</div>
                                    <div class="text-3xl font-bold" id="totalProfiles">0</div>
                                    <div>‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç</div>
                                </div>
                                <div class="bg-green-500 text-white rounded-xl p-6">
                                    <div class="text-4xl mb-2">üéØ</div>
                                    <div class="text-3xl font-bold" id="totalMatches">0</div>
                                    <div>‡∞∏‡±Ç‡∞ö‡∞ø‡∞Ç‡∞ö‡∞ø‡∞® ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç‡∞≤‡±Å</div>
                                </div>
                                <div class="bg-purple-500 text-white rounded-xl p-6">
                                    <div class="text-4xl mb-2">‚úÖ</div>
                                    <div class="text-3xl font-bold" id="approvedMatches">0</div>
                                    <div>‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞®</div>
                                </div>
                                <div class="bg-orange-500 text-white rounded-xl p-6">
                                    <div class="text-4xl mb-2">üíë</div>
                                    <div class="text-3xl font-bold" id="successRate">0%</div>
                                    <div>‡∞µ‡∞ø‡∞ú‡∞Ø ‡∞∞‡±á‡∞ü‡±Å</div>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold mb-4">‡∞Ö‡∞®‡±ç‡∞®‡∞ø ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç</h2>
                                <div id="profilesList">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    await supabase.auth.signOut();
                });

                window.showMatchingView = showMatchingView;
                loadDashboardData();
            }

            async function loadDashboardData() {
                const { data: profiles } = await supabase.from('profiles').select('*');
                const { data: matches } = await supabase.from('matches').select('*');
                
                document.getElementById('totalProfiles').textContent = profiles?.length || 0;
                document.getElementById('totalMatches').textContent = matches?.length || 0;
                
                const approved = matches?.filter(m => m.approved_by_uncle).length || 0;
                document.getElementById('approvedMatches').textContent = approved;
                document.getElementById('successRate').textContent = 
                    matches?.length > 0 ? Math.round((approved / matches.length) * 100) + '%' : '0%';

                loadAllProfiles();
            }

            async function loadAllProfiles() {
                try {
                    const { data, error } = await supabase.from('profiles').select('*').order('created_at', { ascending: false });
                    if (error) throw error;

                    if (!data || data.length === 0) {
                        document.getElementById('profilesList').innerHTML = '<p class="text-gray-500">‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç ‡∞≤‡±á‡∞µ‡±Å</p>';
                        return;
                    }

                    document.getElementById('profilesList').innerHTML = data.map(p => {
                        const photos = p.photos || (p.photo_url ? [p.photo_url] : []);
                        const photosJson = JSON.stringify(photos).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        const safeName = (p.name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        return `
                        <div class="border rounded-lg p-4 mb-4 hover:bg-gray-50 flex gap-4">
                            ${photos.length > 0 ? `
                                <div class="flex-shrink-0">
                                    <div class="relative">
                                        <img src="${photos[0]}" alt="Photo" 
                                             class="w-32 h-32 object-cover rounded-lg cursor-pointer hover:opacity-80 transition border-2 border-blue-500"
                                             onclick='window.showPhotoGalleryGlobal(${photosJson}, "${safeName}", 0)' />
                                        ${photos.length > 1 ? `
                                            <div class="absolute bottom-1 right-1 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded">
                                                +${photos.length - 1}
                                            </div>
                                        ` : ''}
                                    </div>
                                    ${photos.length > 1 ? `
                                        <div class="flex gap-1 mt-2">
                                            ${photos.slice(1, 3).map((photo, idx) => `
                                                <img src="${photo}" alt="Photo ${idx + 2}" 
                                                     class="w-10 h-10 object-cover rounded cursor-pointer hover:opacity-80 border border-gray-300"
                                                     onclick='window.showPhotoGalleryGlobal(${photosJson}, "${safeName}", ${idx + 1})' />
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            <div class="flex-grow">
                                <h3 class="text-2xl font-bold text-gray-800">${p.name || 'N/A'}</h3>
                                <p class="text-lg text-gray-600 mb-2">${p.name_eng || ''}</p>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <p><span class="font-semibold">‡∞≤‡∞ø‡∞Ç‡∞ó‡∞Ç:</span> ${p.gender === 'boy' ? '‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø' : '‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø'}</p>
                                    <p><span class="font-semibold">‡∞∏‡∞Ç‡∞µ‡∞§‡±ç‡∞∏‡∞∞‡∞Ç:</span> ${p.year || 'N/A'}</p>
                                    <p><span class="font-semibold">‡∞â‡∞¶‡±ç‡∞Ø‡±ã‡∞ó‡∞Ç:</span> ${p.profession || 'N/A'}</p>
                                    <p><span class="font-semibold">VIP ‡∞∏‡±ç‡∞•‡∞æ‡∞Ø‡∞ø:</span> ${p.vip_level || 'N/A'}/5</p>
                                    <p><span class="font-semibold">‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç:</span> ${p.location || 'N/A'}</p>
                                    <p><span class="font-semibold">‡∞â‡∞™-‡∞ï‡±Å‡∞≤‡∞Ç:</span> ${p.sub_caste || 'N/A'}</p>
                                    <p><span class="font-semibold">‡∞®‡∞ø‡∞ï‡∞∞ ‡∞µ‡∞ø‡∞≤‡±Å‡∞µ:</span> ${p.net_worth || 'N/A'}</p>
                                    <p><span class="font-semibold">‡∞µ‡∞∞‡∞ï‡∞ü‡±ç‡∞®‡∞Ç:</span> ${p.dowry_expectation || 'N/A'}</p>
                                    <p><span class="font-semibold">‡∞´‡±ã‡∞®‡±ç:</span> ${p.phone || 'N/A'}</p>
                                </div>
                                <div class="mt-4 flex gap-2">
                                    <button onclick="sendToWhatsApp('${p.id}', '${safeName}')" 
                                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">
                                        üì± ‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞æ‡∞™‡±ç‚Äå‡∞ï‡±Å ‡∞™‡∞Ç‡∞™‡∞ø‡∞Ç‡∞ö‡±Å
                                    </button>
                                    <button onclick="deleteProfile('${p.id}', '${safeName}')" 
                                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
                                        üóëÔ∏è ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡±Å
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('');
                } catch (error) {
                    document.getElementById('profilesList').innerHTML = `<p class="text-red-600">‡∞≤‡±ã‡∞™‡∞Ç: ${error.message}</p>`;
                }
            }

            async function deleteProfile(profileId, profileName) {
                const confirmed = confirm(`‡∞Æ‡±Ä‡∞∞‡±Å ‡∞ñ‡∞ö‡±ç‡∞ö‡∞ø‡∞§‡∞Ç‡∞ó‡∞æ "${profileName}" ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‚Äå‡∞®‡±Å ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡∞æ‡∞≤‡∞®‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡∞æ?\n\n‡∞à ‡∞ö‡∞∞‡±ç‡∞Ø ‡∞∞‡∞¶‡±ç‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞¨‡∞°‡∞¶‡±Å.`);
                
                if (!confirmed) return;

                const deleteBtn = event.target;
                deleteBtn.disabled = true;
                deleteBtn.textContent = '‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...';

                try {
                    // First check if profile exists
                    const { data: checkData, error: checkError } = await supabase
                        .from('profiles')
                        .select('id')
                        .eq('id', profileId)
                        .single();

                    if (checkError) {
                        throw new Error('‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç ‡∞ï‡∞®‡±Å‡∞ó‡±ä‡∞®‡∞¨‡∞°‡∞≤‡±á‡∞¶‡±Å');
                    }

                    // Delete the profile
                    const { error } = await supabase
                        .from('profiles')
                        .delete()
                        .eq('id', profileId);

                    if (error) {
                        console.error('Delete error:', error);
                        throw new Error(`‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞™‡±Å ‡∞µ‡∞ø‡∞´‡∞≤‡∞Æ‡±à‡∞Ç‡∞¶‡∞ø: ${error.message}`);
                    }

                    alert('‚úì ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç ‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø');
                    
                    // Reload the appropriate view
                    if (currentUserData.role === 'uncle') {
                        loadAllProfiles();
                    } else {
                        loadAgentProfiles();
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('‡∞≤‡±ã‡∞™‡∞Ç: ' + error.message);
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'üóëÔ∏è ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡±Å';
                }
            }

            window.deleteProfile = deleteProfile;

            async function sendToWhatsApp(profileId, profileName) {
                try {
                    // Fetch the full profile
                    const { data: profile, error } = await supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', profileId)
                        .single();

                    if (error) throw error;

                    // Create biodata message in Telugu
                    const message = `üôè ‡∞®‡∞Æ‡∞∏‡±ç‡∞ï‡∞æ‡∞∞‡∞Ç,

*VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä*

üìã *‡∞¨‡∞Ø‡±ã‡∞°‡±á‡∞ü‡∞æ ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å:*

üë§ *‡∞™‡±á‡∞∞‡±Å:* ${profile.name || 'N/A'}
üìù *English Name:* ${profile.name_eng || 'N/A'}
üë• *‡∞≤‡∞ø‡∞Ç‡∞ó‡∞Ç:* ${profile.gender === 'boy' ? '‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø üë¶' : '‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø üëß'}
üìÖ *‡∞∏‡∞Ç‡∞µ‡∞§‡±ç‡∞∏‡∞∞‡∞Ç:* ${profile.year || 'N/A'}
üìè *‡∞é‡∞§‡±ç‡∞§‡±Å:* ${profile.height || 'N/A'}
üéì *‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø:* ${profile.education || 'N/A'}
üíº *‡∞â‡∞¶‡±ç‡∞Ø‡±ã‡∞ó‡∞Ç:* ${profile.profession || 'N/A'}
‚≠ê *VIP ‡∞∏‡±ç‡∞•‡∞æ‡∞Ø‡∞ø:* ${profile.vip_level || 'N/A'}/5

üí∞ *‡∞Ü‡∞∞‡±ç‡∞•‡∞ø‡∞ï ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å:*
üíé *‡∞®‡∞ø‡∞ï‡∞∞ ‡∞µ‡∞ø‡∞≤‡±Å‡∞µ:* ${profile.net_worth || 'N/A'}
üíç *‡∞µ‡∞∞‡∞ï‡∞ü‡±ç‡∞®‡∞Ç:* ${profile.dowry_expectation || 'N/A'}
üè† *‡∞Ü‡∞∏‡±ç‡∞§‡∞ø:* ${profile.property_details || 'N/A'}

üë®‚Äçüë©‚Äçüëß‚Äçüë¶ *‡∞ï‡±Å‡∞ü‡±Å‡∞Ç‡∞¨ ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å:*
üèõÔ∏è *‡∞â‡∞™-‡∞ï‡±Å‡∞≤‡∞Ç:* ${profile.sub_caste || 'N/A'}
üë® *‡∞§‡∞Ç‡∞°‡±ç‡∞∞‡∞ø:* ${profile.father_name || 'N/A'}
üë© *‡∞§‡∞≤‡±ç‡∞≤‡∞ø:* ${profile.mother_name || 'N/A'}
üë´ *‡∞§‡±ã‡∞¨‡±Å‡∞ü‡±ç‡∞ü‡±Å‡∞µ‡±Å‡∞≤‡±Å:* ${profile.siblings_count || 'N/A'}

üìç *‡∞∏‡±ç‡∞•‡∞æ‡∞® ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å:*
üèôÔ∏è *‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§ ‡∞®‡∞ó‡∞∞‡∞Ç:* ${profile.location || 'N/A'}
üè° *‡∞∏‡±ç‡∞µ‡∞∏‡±ç‡∞•‡∞≤‡∞Ç:* ${profile.native_place || 'N/A'}

üìû *‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞™‡±Å:*
üì± *‡∞´‡±ã‡∞®‡±ç:* ${profile.phone || 'N/A'}
üí¨ *‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞æ‡∞™‡±ç:* ${profile.whatsapp || profile.phone || 'N/A'}

${profile.political_connections ? `üèõÔ∏è *‡∞∞‡∞æ‡∞ú‡∞ï‡±Ä‡∞Ø ‡∞∏‡∞Ç‡∞¨‡∞Ç‡∞ß‡∞æ‡∞≤‡±Å:* ${profile.political_connections}\n` : ''}
-----------------------------------
*VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä*
‡∞µ‡±É‡∞§‡±ç‡∞§‡∞ø‡∞™‡∞∞‡∞Æ‡±à‡∞® ‡∞™‡±Ü‡∞≥‡±ç‡∞≤‡∞ø‡∞ï‡±Ç‡∞§‡±Å‡∞∞ ‡∞µ‡±ç‡∞Ø‡∞µ‡∞∏‡±ç‡∞•`;

                    // Encode message for URL
                    const encodedMessage = encodeURIComponent(message);
                    
                    // Open WhatsApp with pre-filled message
                    // For mobile: whatsapp://send
                    // For web: https://wa.me or https://web.whatsapp.com
                    const whatsappURL = `https://wa.me/?text=${encodedMessage}`;
                    
                    // Show modal with options
                    showWhatsAppModal(whatsappURL, message, profile);
                    
                } catch (error) {
                    alert('‡∞≤‡±ã‡∞™‡∞Ç: ' + error.message);
                }
            }

            function showWhatsAppModal(whatsappURL, message, profile) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold">üì± ‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞æ‡∞™‡±ç‚Äå‡∞ï‡±Å ‡∞™‡∞Ç‡∞™‡∞ø‡∞Ç‡∞ö‡±Å</h2>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-3xl">√ó</button>
                            </div>
                            
                            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-green-800 mb-2">üìã <strong>‡∞∏‡∞Ç‡∞¶‡±á‡∞∂‡∞Ç ‡∞™‡±ç‡∞∞‡∞ø‡∞µ‡±ç‡∞Ø‡±Ç:</strong></p>
                                <pre class="text-xs bg-white p-3 rounded border whitespace-pre-wrap font-sans">${message}</pre>
                            </div>

                            ${profile.phone || profile.whatsapp ? `
                                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                                    <p class="text-sm font-semibold mb-2">üìû ‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞™‡±Å ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç:</p>
                                    <p class="text-lg font-mono">${profile.whatsapp || profile.phone}</p>
                                </div>
                            ` : ''}

                            <div class="space-y-3">
                                <button onclick="window.open('${whatsappURL}', '_blank')" 
                                    class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 flex items-center justify-center gap-2">
                                    <span class="text-xl">üí¨</span>
                                    ‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞æ‡∞™‡±ç ‡∞§‡±Ü‡∞∞‡∞µ‡∞Ç‡∞°‡∞ø (‡∞è‡∞¶‡±à‡∞®‡∞æ ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç‚Äå‡∞ï‡±Å)
                                </button>

                                ${profile.phone || profile.whatsapp ? `
                                    <button onclick="window.open('https://wa.me/${(profile.whatsapp || profile.phone).replace(/[^0-9]/g, '')}?text=${encodeURIComponent(message)}', '_blank')" 
                                        class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold hover:bg-blue-600 flex items-center justify-center gap-2">
                                        <span class="text-xl">üì±</span>
                                        ‡∞®‡±á‡∞∞‡±Å‡∞ó‡∞æ ${profile.whatsapp || profile.phone} ‡∞ï‡±Å ‡∞™‡∞Ç‡∞™‡∞ø‡∞Ç‡∞ö‡±Å
                                    </button>
                                ` : ''}

                                <button onclick="copyToClipboard(\`${message.replace(/`/g, '\\`')}\`)" 
                                    class="w-full bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 flex items-center justify-center gap-2">
                                    <span class="text-xl">üìã</span>
                                    ‡∞∏‡∞Ç‡∞¶‡±á‡∞∂‡∞Ç ‡∞ï‡∞æ‡∞™‡±Ä ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø
                                </button>

                                <button onclick="this.closest('.fixed').remove()" 
                                    class="w-full bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">
                                    ‡∞∞‡∞¶‡±ç‡∞¶‡±Å ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('‚úì ‡∞∏‡∞Ç‡∞¶‡±á‡∞∂‡∞Ç ‡∞ï‡±ç‡∞≤‡∞ø‡∞™‡±ç‚Äå‡∞¨‡±ã‡∞∞‡±ç‡∞°‡±ç‚Äå‡∞ï‡±Å ‡∞ï‡∞æ‡∞™‡±Ä ‡∞ö‡±á‡∞Ø‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø!');
                }).catch(() => {
                    alert('‡∞ï‡∞æ‡∞™‡±Ä ‡∞ö‡±á‡∞Ø‡∞°‡∞Ç ‡∞µ‡∞ø‡∞´‡∞≤‡∞Æ‡±à‡∞Ç‡∞¶‡∞ø');
                });
            }

            window.sendToWhatsApp = sendToWhatsApp;
            window.copyToClipboard = copyToClipboard;

            async function showMatchingView() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen p-6">
                        <div class="max-w-7xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <h1 class="text-3xl font-bold">‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡∞ø‡∞Ç‡∞ó‡±ç ‡∞∏‡∞ø‡∞∏‡±ç‡∞ü‡∞Æ‡±ç</h1>
                                    <button onclick="location.reload()" class="px-6 py-2 bg-gray-500 text-white rounded-lg">
                                        ‡∞µ‡±Ü‡∞®‡∞ï‡±ç‡∞ï‡∞ø
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-6">
                                <div class="bg-white rounded-2xl shadow-xl p-6">
                                    <h2 class="text-2xl font-bold mb-4">‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø‡∞≤ ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç</h2>
                                    <div id="boysList">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>
                                </div>
                                <div class="bg-white rounded-2xl shadow-xl p-6">
                                    <h2 class="text-2xl font-bold mb-4">‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø‡∞≤ ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç</h2>
                                    <div id="girlsList">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>
                                </div>
                            </div>

                            <div id="matchResults" class="mt-6"></div>
                        </div>
                    </div>
                `;

                await loadMatchingProfiles();
            }

            async function loadMatchingProfiles() {
                const { data: boys } = await supabase.from('profiles').select('*').eq('gender', 'boy');
                const { data: girls } = await supabase.from('profiles').select('*').eq('gender', 'girl');

                document.getElementById('boysList').innerHTML = (boys || []).map(b => `
                    <div class="border rounded-lg p-3 mb-3 cursor-pointer hover:bg-blue-50" onclick="findMatches('${b.id}', 'boy')">
                        <p class="font-bold">${b.name}</p>
                        <p class="text-sm text-gray-600">${b.profession} | ${b.year}</p>
                    </div>
                `).join('') || '<p class="text-gray-500">‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø‡∞≤‡±Å ‡∞≤‡±á‡∞∞‡±Å</p>';

                document.getElementById('girlsList').innerHTML = (girls || []).map(g => `
                    <div class="border rounded-lg p-3 mb-3 cursor-pointer hover:bg-pink-50" onclick="findMatches('${g.id}', 'girl')">
                        <p class="font-bold">${g.name}</p>
                        <p class="text-sm text-gray-600">${g.profession} | ${g.year}</p>
                    </div>
                `).join('') || '<p class="text-gray-500">‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø‡∞≤‡±Å ‡∞≤‡±á‡∞∞‡±Å</p>';

                window.findMatches = findMatches;
            }

            async function findMatches(profileId, gender) {
                const { data: profile } = await supabase.from('profiles').select('*').eq('id', profileId).single();
                const oppositeGender = gender === 'boy' ? 'girl' : 'boy';
                const { data: candidates } = await supabase.from('profiles').select('*').eq('gender', oppositeGender);

                if (!candidates || candidates.length === 0) {
                    document.getElementById('matchResults').innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg">
                            ${oppositeGender === 'girl' ? '‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø‡∞≤' : '‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø‡∞≤'} ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç ‡∞≤‡±á‡∞µ‡±Å
                        </div>
                    `;
                    return;
                }

                const matches = candidates.map(candidate => ({
                    candidate,
                    score: calculateMatchScore(profile, candidate),
                    reasons: getMatchReasons(profile, candidate)
                })).filter(m => m.score >= 75).sort((a, b) => b.score - a.score);

                if (matches.length === 0) {
                    document.getElementById('matchResults').innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg">
                            75% ‡∞ï‡∞Ç‡∞ü‡±á ‡∞é‡∞ï‡±ç‡∞ï‡±Å‡∞µ ‡∞∏‡±ç‡∞ï‡±ã‡∞∞‡±ç ‡∞â‡∞®‡±ç‡∞® ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç‡∞≤‡±Å ‡∞≤‡±á‡∞µ‡±Å
                        </div>
                    `;
                    return;
                }

                document.getElementById('matchResults').innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold mb-4">‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç ‡∞∏‡±Ç‡∞ö‡∞®‡∞≤‡±Å: ${profile.name}</h2>
                        ${matches.map((m, i) => `
                            <div class="border-2 ${i === 0 ? 'border-green-500' : 'border-gray-300'} rounded-lg p-6 mb-4">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-2xl font-bold">${i + 1}. ${m.candidate.name}</h3>
                                        <p class="text-gray-600">${m.candidate.name_eng}</p>
                                        <p class="text-sm text-gray-500">${m.candidate.profession} | ${m.candidate.year}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-4xl font-bold text-green-600">${m.score}%</div>
                                        <div class="text-sm text-gray-500">‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç ‡∞∏‡±ç‡∞ï‡±ã‡∞∞‡±ç</div>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                    <p class="font-semibold mb-2">‡∞é‡∞Ç‡∞¶‡±Å‡∞ï‡±Å ‡∞à ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç:</p>
                                    <ul class="space-y-1">
                                        ${m.reasons.map(r => `<li class="text-sm">‚úì ${r}</li>`).join('')}
                                    </ul>
                                </div>

                                <button onclick="approveMatch('${profile.id}', '${m.candidate.id}', ${m.score}, ${JSON.stringify(m.reasons).replace(/"/g, '&quot;')})" 
                                    class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600">
                                    ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç ‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;

                window.approveMatch = approveMatch;
            }

            function calculateMatchScore(profile1, profile2) {
                let score = 0;

                const wealth1 = parseFloat(profile1.net_worth) || 0;
                const wealth2 = parseFloat(profile2.net_worth) || 0;
                const wealthDiff = Math.abs(wealth1 - wealth2);
                if (wealthDiff < 10) score += 40;
                else if (wealthDiff < 20) score += 30;
                else if (wealthDiff < 50) score += 20;
                else score += 10;

                const dowry1 = parseFloat(profile1.dowry_expectation) || 0;
                const dowry2 = parseFloat(profile2.dowry_expectation) || 0;
                if (Math.abs(dowry1 - dowry2) < 5) score += 30;
                else if (Math.abs(dowry1 - dowry2) < 10) score += 20;
                else score += 10;

                const age1 = parseInt(profile1.year) || 0;
                const age2 = parseInt(profile2.year) || 0;
                const ageDiff = Math.abs(age1 - age2);
                if (ageDiff <= 3) score += 15;
                else if (ageDiff <= 5) score += 10;
                else if (ageDiff <= 7) score += 5;

                if (profile1.sub_caste === profile2.sub_caste) score += 10;

                if (profile1.political_connections && profile2.political_connections) score += 5;

                return score;
            }

            function getMatchReasons(profile1, profile2) {
                const reasons = [];
                
                const wealth1 = parseFloat(profile1.net_worth) || 0;
                const wealth2 = parseFloat(profile2.net_worth) || 0;
                if (Math.abs(wealth1 - wealth2) < 10) {
                    reasons.push(`‡∞∏‡∞Æ‡∞æ‡∞® ‡∞Ü‡∞∏‡±ç‡∞§‡∞ø ‡∞∏‡±ç‡∞•‡∞æ‡∞Ø‡∞ø (${profile1.net_worth} ~ ${profile2.net_worth})`);
                }

                if (profile1.sub_caste === profile2.sub_caste) {
                    reasons.push(`‡∞í‡∞ï‡±á ‡∞â‡∞™-‡∞ï‡±Å‡∞≤‡∞Ç (${profile1.sub_caste})`);
                }

                const ageDiff = Math.abs(parseInt(profile1.year) - parseInt(profile2.year));
                if (ageDiff <= 5) {
                    reasons.push(`‡∞∏‡∞∞‡±à‡∞® ‡∞µ‡∞Ø‡∞∏‡±ç‡∞∏‡±Å ‡∞§‡±á‡∞°‡∞æ (${ageDiff} ‡∞∏‡∞Ç‡∞µ‡∞§‡±ç‡∞∏‡∞∞‡∞æ‡∞≤‡±Å)`);
                }

                if (profile1.profession && profile2.profession) {
                    reasons.push(`‡∞µ‡±É‡∞§‡±ç‡∞§‡∞ø: ${profile1.profession} & ${profile2.profession}`);
                }

                if (profile1.location === profile2.location) {
                    reasons.push(`‡∞í‡∞ï‡±á ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç (${profile1.location})`);
                }

                return reasons;
            }

            async function approveMatch(boyId, girlId, score, reasons) {
                try {
                    const { error } = await supabase.from('matches').insert({
                        boy_profile_id: boyId,
                        girl_profile_id: girlId,
                        match_score: score,
                        match_reasons: reasons,
                        status: 'approved',
                        approved_by_uncle: true,
                        approved_at: new Date().toISOString()
                    });

                    if (error) throw error;

                    alert('‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç ‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø! ‚úÖ');
                    location.reload();
                } catch (error) {
                    alert('‡∞≤‡±ã‡∞™‡∞Ç: ' + error.message);
                }
            }

            function showAgentPortal() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen p-6">
                        <div class="max-w-6xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-3xl font-bold">‡∞è‡∞ú‡±Ü‡∞Ç‡∞ü‡±ç ‡∞™‡±ã‡∞∞‡±ç‡∞ü‡∞≤‡±ç</h1>
                                        <p class="text-gray-600">‡∞∏‡±ç‡∞µ‡∞æ‡∞ó‡∞§‡∞Ç, ${currentUserData.name}</p>
                                    </div>
                                    <button id="logoutBtnAgent" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                        ‡∞≤‡∞æ‡∞ó‡±ç‡∞Ö‡∞µ‡±Å‡∞ü‡±ç
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <h2 class="text-2xl font-bold mb-4">‡∞¨‡∞Ø‡±ã‡∞°‡±á‡∞ü‡∞æ ‡∞Ö‡∞™‡±ç‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø</h2>
                                
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4">
                                    <div class="text-5xl mb-4">üìÑ</div>
                                    <input type="file" id="biodataFile" accept=".txt,.pdf" class="hidden" />
                                    <button onclick="document.getElementById('biodataFile').click()" 
                                        class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold">
                                        ‡∞¨‡∞Ø‡±ã‡∞°‡±á‡∞ü‡∞æ ‡∞´‡±à‡∞≤‡±ç ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø
                                    </button>
                                    <p class="text-sm text-gray-500 mt-2">TXT ‡∞≤‡±á‡∞¶‡∞æ PDF ‡∞´‡±à‡∞≤‡±ç</p>
                                </div>

                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                    <div class="text-5xl mb-4">üì∑</div>
                                    <input type="file" id="photoFile" accept="image/*" multiple class="hidden" />
                                    <button onclick="document.getElementById('photoFile').click()" 
                                        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold">
                                        ‡∞´‡±ã‡∞ü‡±ã‡∞≤‡±Å ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø (‡∞ó‡∞∞‡∞ø‡∞∑‡±ç‡∞ü‡∞Ç‡∞ó‡∞æ 5)
                                    </button>
                                    <p class="text-sm text-gray-500 mt-2">‡∞¨‡∞π‡±Å‡∞≥ ‡∞´‡±ã‡∞ü‡±ã‡∞≤‡±Å ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø (‡∞ê‡∞ö‡±ç‡∞õ‡∞ø‡∞ï‡∞Ç)</p>
                                    <div id="photoPreview" class="mt-4 hidden">
                                        <div id="previewContainer" class="grid grid-cols-3 gap-2"></div>
                                    </div>
                                </div>

                                <div id="uploadStatus" class="mt-4 hidden"></div>

                                <div id="extractedDataForm" class="mt-6 hidden">
                                    <h3 class="text-xl font-bold mb-4 text-green-600">‚úì AI ‡∞°‡±á‡∞ü‡∞æ ‡∞∏‡∞Ç‡∞ó‡±ç‡∞∞‡∞π‡∞ø‡∞Ç‡∞ö‡∞ø‡∞Ç‡∞¶‡∞ø - ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞∏‡∞∞‡∞ø‡∞ö‡±Ç‡∞°‡∞Ç‡∞°‡∞ø</h3>
                                    <form id="profileForm" class="grid grid-cols-2 gap-4">
                                        <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2">‡∞µ‡±ç‡∞Ø‡∞ï‡±ç‡∞§‡∞ø‡∞ó‡∞§ ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                        <input type="text" id="name" placeholder="‡∞™‡±á‡∞∞‡±Å (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å‡∞≤‡±ã)" required class="px-4 py-2 border rounded-lg bg-yellow-50" />
                                        <input type="text" id="nameEng" placeholder="Name (English)" required class="px-4 py-2 border rounded-lg bg-yellow-50" />
                                        <select id="gender" required class="px-4 py-2 border rounded-lg bg-yellow-50">
                                            <option value="">‡∞≤‡∞ø‡∞Ç‡∞ó‡∞Ç ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø</option>
                                            <option value="boy">‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø</option>
                                            <option value="girl">‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø</option>
                                        </select>
                                        <input type="number" id="year" placeholder="‡∞ú‡∞®‡∞®‡∞Ç ‡∞∏‡∞Ç‡∞µ‡∞§‡±ç‡∞∏‡∞∞‡∞Ç" required class="px-4 py-2 border rounded-lg bg-yellow-50" />
                                        <input type="text" id="height" placeholder="‡∞é‡∞§‡±ç‡∞§‡±Å" class="px-4 py-2 border rounded-lg" />
                                        <input type="text" id="education" placeholder="‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø" class="px-4 py-2 border rounded-lg" />
                                        
                                        <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2 mt-4">VIP ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                        <input type="text" id="profession" placeholder="‡∞â‡∞¶‡±ç‡∞Ø‡±ã‡∞ó‡∞Ç" class="px-4 py-2 border rounded-lg" />
                                        <select id="vipLevel" class="px-4 py-2 border rounded-lg">
                                            <option value="">VIP ‡∞∏‡±ç‡∞•‡∞æ‡∞Ø‡∞ø</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                        <input type="text" id="politicalConnections" placeholder="‡∞∞‡∞æ‡∞ú‡∞ï‡±Ä‡∞Ø ‡∞∏‡∞Ç‡∞¨‡∞Ç‡∞ß‡∞æ‡∞≤‡±Å" class="px-4 py-2 border rounded-lg col-span-2" />
                                        
                                        <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2 mt-4">‡∞Ü‡∞∞‡±ç‡∞•‡∞ø‡∞ï ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                        <input type="text" id="netWorth" placeholder="‡∞®‡∞ø‡∞ï‡∞∞ ‡∞µ‡∞ø‡∞≤‡±Å‡∞µ (‡∞ï‡±ã‡∞ü‡±ç‡∞≤‡∞≤‡±ã)" class="px-4 py-2 border rounded-lg bg-yellow-50" />
                                        <input type="text" id="dowryExpectation" placeholder="‡∞µ‡∞∞‡∞ï‡∞ü‡±ç‡∞®‡∞Ç (‡∞ï‡±ã‡∞ü‡±ç‡∞≤‡∞≤‡±ã)" class="px-4 py-2 border rounded-lg bg-yellow-50" />
                                        <textarea id="propertyDetails" placeholder="‡∞Ü‡∞∏‡±ç‡∞§‡∞ø ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å" class="px-4 py-2 border rounded-lg col-span-2" rows="2"></textarea>
                                        
                                        <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2 mt-4">‡∞ï‡±Å‡∞ü‡±Å‡∞Ç‡∞¨ ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                        <input type="text" id="subCaste" placeholder="‡∞â‡∞™-‡∞ï‡±Å‡∞≤‡∞Ç" class="px-4 py-2 border rounded-lg bg-yellow-50" />
                                        <input type="text" id="fatherName" placeholder="‡∞§‡∞Ç‡∞°‡±ç‡∞∞‡∞ø ‡∞™‡±á‡∞∞‡±Å" class="px-4 py-2 border rounded-lg" />
                                        <input type="text" id="motherName" placeholder="‡∞§‡∞≤‡±ç‡∞≤‡∞ø ‡∞™‡±á‡∞∞‡±Å" class="px-4 py-2 border rounded-lg" />
                                        <input type="number" id="siblingsCount" placeholder="‡∞§‡±ã‡∞¨‡±Å‡∞ü‡±ç‡∞ü‡±Å‡∞µ‡±Å‡∞≤ ‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø" class="px-4 py-2 border rounded-lg" />
                                        
                                        <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2 mt-4">‡∞∏‡±ç‡∞•‡∞æ‡∞® ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                        <input type="text" id="location" placeholder="‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§ ‡∞®‡∞ó‡∞∞‡∞Ç" class="px-4 py-2 border rounded-lg bg-yellow-50" />
                                        <input type="text" id="nativePlace" placeholder="‡∞∏‡±ç‡∞µ‡∞∏‡±ç‡∞•‡∞≤‡∞Ç" class="px-4 py-2 border rounded-lg" />
                                        
                                        <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2 mt-4">‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞™‡±Å ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                        <input type="tel" id="phone" placeholder="‡∞´‡±ã‡∞®‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç" required class="px-4 py-2 border rounded-lg bg-yellow-50" />
                                        <input type="tel" id="whatsapp" placeholder="‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞™‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç" class="px-4 py-2 border rounded-lg" />
                                        
                                        <button type="submit" class="col-span-2 mt-4 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600">
                                            ‚úì ‡∞∏‡∞∞‡∞ø‡∞ö‡±Ç‡∞∏‡∞ø ‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold mb-4">‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç</h2>
                                <div id="agentProfiles">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('logoutBtnAgent').addEventListener('click', async () => {
                    await supabase.auth.signOut();
                });

                document.getElementById('photoFile').addEventListener('change', (e) => {
                    const files = Array.from(e.target.files).slice(0, 5);
                    if (files.length > 0) {
                        const container = document.getElementById('previewContainer');
                        container.innerHTML = '';
                        
                        files.forEach((file, index) => {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const div = document.createElement('div');
                                div.className = 'relative';
                                div.innerHTML = `
                                    <img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg" data-index="${index}" />
                                    <button type="button" onclick="removePhoto(${index})" 
                                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs hover:bg-red-600">
                                        √ó
                                    </button>
                                `;
                                container.appendChild(div);
                            };
                            reader.readAsDataURL(file);
                        });
                        
                        document.getElementById('photoPreview').classList.remove('hidden');
                    }
                });

                window.removePhoto = (index) => {
                    const container = document.getElementById('previewContainer');
                    const imgs = container.querySelectorAll('img');
                    if (imgs[index]) {
                        imgs[index].parentElement.remove();
                    }
                    if (container.children.length === 0) {
                        document.getElementById('photoPreview').classList.add('hidden');
                    }
                };

                document.getElementById('biodataFile').addEventListener('change', handleBiodataUpload);

                loadAgentProfiles();
            }

            async function handleBiodataUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const statusDiv = document.getElementById('uploadStatus');
                statusDiv.classList.remove('hidden');
                statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-700 p-3 rounded">AI ‡∞™‡±ç‡∞∞‡∞æ‡∞∏‡±Ü‡∞∏‡±ç ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø... ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞µ‡±á‡∞ö‡∞ø ‡∞â‡∞Ç‡∞°‡∞Ç‡∞°‡∞ø</div>';

                try {
                    let text = '';
                    
                    // Check if it's a PDF file
                    if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                        statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-700 p-3 rounded">üìÑ PDF ‡∞ö‡∞¶‡±Å‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø... ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞µ‡±á‡∞ö‡∞ø ‡∞â‡∞Ç‡∞°‡∞Ç‡∞°‡∞ø</div>';
                        text = await extractTextFromPDF(file);
                        if (!text || text.trim().length === 0) {
                            throw new Error('PDF ‡∞®‡±Å‡∞Ç‡∞°‡∞ø ‡∞ü‡±Ü‡∞ï‡±ç‡∞∏‡±ç‡∞ü‡±ç ‡∞∏‡∞Ç‡∞ó‡±ç‡∞∞‡∞π‡∞ø‡∞Ç‡∞ö‡∞≤‡±á‡∞ï‡∞™‡±ã‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø');
                        }
                    } else {
                        // Handle text file
                        text = await file.text();
                    }

                    statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-700 p-3 rounded">ü§ñ AI ‡∞°‡±á‡∞ü‡∞æ ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞ø‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>';
                    
                    const extractedData = await extractBiodataWithAI(text);
                    
                    statusDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 p-3 rounded">‚úì ‡∞°‡±á‡∞ü‡∞æ ‡∞∏‡∞Ç‡∞ó‡±ç‡∞∞‡∞π‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø! ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞¶‡∞ø‡∞ó‡±Å‡∞µ ‡∞´‡∞æ‡∞∞‡∞Æ‡±ç‚Äå‡∞®‡±Å ‡∞∏‡∞∞‡∞ø‡∞ö‡±Ç‡∞°‡∞Ç‡∞°‡∞ø</div>';
                    
                    document.getElementById('extractedDataForm').classList.remove('hidden');
                    document.getElementById('name').value = extractedData.name || '';
                    document.getElementById('nameEng').value = extractedData.nameEng || '';
                    document.getElementById('gender').value = extractedData.gender || '';
                    document.getElementById('year').value = extractedData.year || '';
                    document.getElementById('height').value = extractedData.height || '';
                    document.getElementById('education').value = extractedData.education || '';
                    document.getElementById('profession').value = extractedData.profession || '';
                    document.getElementById('vipLevel').value = extractedData.vipLevel || '';
                    document.getElementById('politicalConnections').value = extractedData.politicalConnections || '';
                    document.getElementById('netWorth').value = extractedData.netWorth || '';
                    document.getElementById('dowryExpectation').value = extractedData.dowryExpectation || '';
                    document.getElementById('propertyDetails').value = extractedData.propertyDetails || '';
                    document.getElementById('subCaste').value = extractedData.subCaste || '';
                    document.getElementById('fatherName').value = extractedData.fatherName || '';
                    document.getElementById('motherName').value = extractedData.motherName || '';
                    document.getElementById('siblingsCount').value = extractedData.siblingsCount || '';
                    document.getElementById('location').value = extractedData.location || '';
                    document.getElementById('nativePlace').value = extractedData.nativePlace || '';
                    document.getElementById('phone').value = extractedData.phone || '';
                    document.getElementById('whatsapp').value = extractedData.whatsapp || '';

                    document.getElementById('profileForm').addEventListener('submit', handleProfileSubmit);
                    
                    setTimeout(() => statusDiv.classList.add('hidden'), 5000);
                } catch (error) {
                    statusDiv.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 p-3 rounded">‡∞≤‡±ã‡∞™‡∞Ç: ${error.message}</div>`;
                }
            }

            async function extractTextFromPDF(file) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = '';

                    // Extract text from all pages
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    }

                    return fullText.trim();
                } catch (error) {
                    throw new Error(`PDF ‡∞™‡±ç‡∞∞‡∞æ‡∞∏‡±Ü‡∞∏‡∞ø‡∞Ç‡∞ó‡±ç ‡∞≤‡±ã‡∞™‡∞Ç: ${error.message}`);
                }
            }

            async function extractBiodataWithAI(text) {
                try {
                    const response = await fetch(AI_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AI_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: 'gemini-2.5-pro',
                            messages: [{
                                role: 'user',
                                content: `Extract biodata information from this text. The text may contain fields like Name, Date of Birth, Place of Birth, Height, Education, Religion/Caste, Job/Occupation, etc. Extract and map them to the JSON fields below.

IMPORTANT INSTRUCTIONS:
1. For gender: If you see "Hindu/Reddy" or just a male name, assume "boy". If female name, assume "girl".
2. For year: Extract from "Date of Birth" (e.g., "20 August 1999" ‚Üí 1999)
3. For nameEng: Use the English name provided
4. For name: Convert the English name to Telugu script if possible, or keep English
5. For profession: Extract from "Job/Occupation" field
6. For height: Extract from "Height" field (e.g., "5 feet 6 inches" ‚Üí "5'6\"")
7. For subCaste: If "Reddy" is mentioned, use "‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø". Look for variants like Panta, Kapu, Velama, Munnuru, Motati, etc.
8. For vipLevel: Estimate 1-5 based on profession (Software Engineer=2, IAS/IPS=4, MLA/Minister=5, Doctor=3)

Return ONLY valid JSON:
{
  "name": "name in Telugu if available, else English",
  "nameEng": "name in English",
  "gender": "boy or girl",
  "year": "birth year as number only (e.g., 1999)",
  "height": "height (e.g., 5'6\\")",
  "education": "education details",
  "profession": "profession/occupation",
  "vipLevel": "1-5 number only",
  "politicalConnections": "if any mentioned",
  "netWorth": "if mentioned, number in crores only",
  "dowryExpectation": "if mentioned, number in crores only",
  "propertyDetails": "if mentioned",
  "subCaste": "sub-caste in Telugu (e.g., ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø, ‡∞ï‡∞™‡±ç‡∞™‡±Å, ‡∞µ‡±Ü‡∞≤‡∞Æ)",
  "fatherName": "if mentioned",
  "motherName": "if mentioned",
  "siblingsCount": "if mentioned",
  "location": "Place of Birth or current location",
  "nativePlace": "native place if mentioned",
  "phone": "phone number if found",
  "whatsapp": "whatsapp number if found"
}

Biodata Text:
${text}

Return ONLY the JSON object, no other text.`
                            }],
                            max_tokens: 1000,
                            temperature: 0.3
                        })
                    });
                    
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    
                    const data = await response.json();
                    
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('Invalid API response');
                    }
                    
                    const content = data.choices[0].message.content;
                    let textContent;
                    
                    if (typeof content === 'string') {
                        textContent = content;
                    } else if (Array.isArray(content) && content[0] && content[0].text) {
                        textContent = content[0].text;
                    } else {
                        throw new Error('Unexpected content format');
                    }
                    
                    const jsonMatch = textContent.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error('No JSON found in AI response');
                    
                    return JSON.parse(jsonMatch[0]);
                } catch (error) {
                    throw new Error(`AI extraction failed: ${error.message}`);
                }
            }

            async function handleProfileSubmit(e) {
                e.preventDefault();
                const statusDiv = document.getElementById('uploadStatus');
                statusDiv.classList.remove('hidden');
                statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-700 p-3 rounded">‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>';

                try {
                    let photoUrls = [];
                    const photoFile = document.getElementById('photoFile');
                    if (photoFile.files.length > 0) {
                        const files = Array.from(photoFile.files).slice(0, 5);
                        for (const file of files) {
                            const photoUrl = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = () => resolve(reader.result);
                                reader.readAsDataURL(file);
                            });
                            photoUrls.push(photoUrl);
                        }
                    }

                    const parseNumber = (val) => {
                        const trimmed = (val || '').trim();
                        return trimmed === '' ? null : trimmed;
                    };

                    const profileData = {
                        name: document.getElementById('name').value || null,
                        name_eng: document.getElementById('nameEng').value || null,
                        gender: document.getElementById('gender').value || null,
                        year: parseNumber(document.getElementById('year').value),
                        height: document.getElementById('height').value || null,
                        education: document.getElementById('education').value || null,
                        profession: document.getElementById('profession').value || null,
                        vip_level: parseNumber(document.getElementById('vipLevel').value),
                        political_connections: document.getElementById('politicalConnections').value || null,
                        net_worth: parseNumber(document.getElementById('netWorth').value),
                        dowry_expectation: parseNumber(document.getElementById('dowryExpectation').value),
                        property_details: document.getElementById('propertyDetails').value || null,
                        sub_caste: document.getElementById('subCaste').value || null,
                        father_name: document.getElementById('fatherName').value || null,
                        mother_name: document.getElementById('motherName').value || null,
                        siblings_count: parseNumber(document.getElementById('siblingsCount').value),
                        location: document.getElementById('location').value || null,
                        native_place: document.getElementById('nativePlace').value || null,
                        phone: document.getElementById('phone').value || null,
                        whatsapp: document.getElementById('whatsapp').value || null,
                        photos: photoUrls.length > 0 ? photoUrls : null,
                        photo_url: photoUrls.length > 0 ? photoUrls[0] : null,
                        agent_id: currentUser.id,
                        agent_name: currentUserData.name,
                        status: 'active'
                    };

                    const { error } = await supabase.from('profiles').insert(profileData);
                    if (error) throw error;

                    statusDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 p-3 rounded">‚úì ‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞Ø‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø!</div>';
                    
                    document.getElementById('biodataFile').value = '';
                    document.getElementById('photoFile').value = '';
                    document.getElementById('photoPreview').classList.add('hidden');
                    document.getElementById('previewContainer').innerHTML = '';
                    document.getElementById('extractedDataForm').classList.add('hidden');
                    
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                        loadAgentProfiles();
                    }, 2000);
                } catch (error) {
                    statusDiv.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 p-3 rounded">‡∞≤‡±ã‡∞™‡∞Ç: ${error.message}</div>`;
                }
            }

            async function loadAgentProfiles() {
                try {
                    const { data, error } = await supabase.from('profiles').select('*').eq('agent_id', currentUser.id);
                    if (error) throw error;

                    if (!data || data.length === 0) {
                        document.getElementById('agentProfiles').innerHTML = '<p class="text-gray-500">‡∞Æ‡±Ä‡∞∞‡±Å ‡∞á‡∞Ç‡∞ï‡∞æ ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞≤‡±á‡∞¶‡±Å</p>';
                        return;
                    }

                    document.getElementById('agentProfiles').innerHTML = data.map(p => {
                        const photos = p.photos || (p.photo_url ? [p.photo_url] : []);
                        const photosJson = JSON.stringify(photos).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        const safeName = (p.name || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        return `
                        <div class="border rounded-lg p-4 mb-4 flex gap-4">
                            ${photos.length > 0 ? `
                                <div class="flex-shrink-0">
                                    <img src="${photos[0]}" 
                                         class="w-24 h-24 object-cover rounded-lg cursor-pointer hover:opacity-80 border-2 border-blue-500" 
                                         onclick='window.showPhotoGalleryGlobal(${photosJson}, "${safeName}", 0)' />
                                    ${photos.length > 1 ? `
                                        <div class="text-xs text-center mt-1 text-gray-600">+${photos.length - 1} ‡∞´‡±ã‡∞ü‡±ã‡∞≤‡±Å</div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            <div>
                                <h3 class="text-lg font-bold">${p.name}</h3>
                                <p class="text-sm text-gray-600">${p.gender === 'boy' ? '‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø' : '‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø'} | ${p.year} | ${p.profession}</p>
                                <p class="text-sm text-gray-500">${p.location}</p>
                                <div class="mt-2">
                                    <button onclick="deleteProfile('${p.id}', '${safeName}')" 
                                        class="px-3 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                                        üóëÔ∏è ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡±Å
                                    </button>
                                </div>
                            </div>
                        </div>
                    `}).join('');
                } catch (error) {
                    document.getElementById('agentProfiles').innerHTML = `<p class="text-red-600">‡∞≤‡±ã‡∞™‡∞Ç: ${error.message}</p>`;
                }
            }
        }
    </script>
</body>
</html>
