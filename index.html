<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 to-red-50 min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="text-6xl mb-4">‚è≥</div>
                <p class="text-gray-600">Loading...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        console.log('Script started');

        // Wait for Supabase to load
        function waitForSupabase() {
            if (typeof window.supabase !== 'undefined') {
                console.log('Supabase loaded');
                startApp();
            } else {
                setTimeout(waitForSupabase, 100);
            }
        }
        waitForSupabase();

        function startApp() {
            // Initialize Supabase
            const SUPABASE_URL = 'https://cmefgdiltjevddraguso.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtZWZnZGlsdGpldmRkcmFndXNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjg5NzAsImV4cCI6MjA3NDk0NDk3MH0.Cz3Acd0Qy5UR_bItqLSSn0zLoLtvvqu1WPG77-PM1RM';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('Supabase initialized');

            // AI API
            const AI_API_URL = 'https://api.euron.one/api/v1/euri/chat/completions';
            const AI_API_KEY = 'euri-806e518a3ad06e4491c2b099282bf8de3fef780b9ed1abde986b954a3c95dad6';

            let currentUser = null;
            let currentUserData = null;

            // Initialize
            initAuth();

            async function initAuth() {
                console.log('Checking session...');
                
                try {
                    // Add timeout to getSession
                    const sessionPromise = supabase.auth.getSession();
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Session check timeout')), 5000)
                    );
                    
                    const { data: { session } } = await Promise.race([sessionPromise, timeoutPromise]);
                    
                    if (session) {
                        console.log('Session found:', session.user.email);
                        currentUser = session.user;
                        await loadUserData();
                        
                        if (currentUserData) {
                            if (currentUserData.role === 'uncle') {
                                showUncleDashboard();
                            } else if (currentUserData.role === 'agent') {
                                showAgentPortal();
                            } else {
                                showLoginPage();
                            }
                        } else {
                            showLoginPage();
                        }
                    } else {
                        console.log('No session found');
                        showLoginPage();
                    }
                } catch (error) {
                    console.error('Session check error:', error);
                    showLoginPage();
                }

                // Listen for auth changes
                supabase.auth.onAuthStateChange(async (event, session) => {
                    console.log('Auth event:', event);
                    if (event === 'SIGNED_IN') {
                        window.location.reload();
                    } else if (event === 'SIGNED_OUT') {
                        window.location.reload();
                    }
                });
            }

            async function loadUserData() {
                try {
                    const { data, error } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();

                    if (error) throw error;
                    currentUserData = data;
                    console.log('User data:', currentUserData);
                } catch (error) {
                    console.error('Error loading user:', error);
                    currentUserData = null;
                }
            }

            function showLoginPage() {
                console.log('Showing login page');
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border-4 border-orange-400">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4">üëë</div>
                                <h1 class="text-3xl font-bold text-gray-800">VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä</h1>
                                <p class="text-gray-600 mt-2">Professional Matchmaking System</p>
                            </div>
                            
                            <form id="loginForm" class="space-y-4">
                                <input 
                                    type="email" 
                                    id="loginEmail" 
                                    required
                                    placeholder="Email"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                                />
                                <input 
                                    type="password" 
                                    id="loginPassword" 
                                    required
                                    placeholder="Password"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                                />
                                <button 
                                    type="submit"
                                    class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-3 rounded-lg font-semibold hover:from-red-700 hover:to-orange-700"
                                >
                                    Login
                                </button>
                            </form>
                            
                            <div id="loginError" class="mt-4 hidden">
                                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                            </div>

                            <div class="mt-6 p-4 bg-gray-50 rounded-lg text-xs text-gray-600">
                                <p class="font-semibold mb-2">Test Credentials:</p>
                                <p>Uncle: uncle@reddy.com / reddy2025</p>
                                <p>Agent: agent@reddy.com / agent123</p>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    const errorDiv = document.getElementById('loginError');

                    try {
                        const { error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    } catch (error) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.querySelector('div').textContent = error.message;
                    }
                });
            }

            function showUncleDashboard() {
                console.log('Showing uncle dashboard');
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen p-6">
                        <div class="max-w-7xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-3xl font-bold">Uncle Dashboard</h1>
                                        <p class="text-gray-600">Welcome, ${currentUserData.name}</p>
                                    </div>
                                    <button id="logoutBtn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                        Logout
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div class="bg-blue-500 text-white rounded-xl p-6">
                                    <div class="text-4xl mb-2">üìä</div>
                                    <div class="text-3xl font-bold" id="totalProfiles">0</div>
                                    <div>Total Profiles</div>
                                </div>
                                <div class="bg-green-500 text-white rounded-xl p-6">
                                    <div class="text-4xl mb-2">üéØ</div>
                                    <div class="text-3xl font-bold">0</div>
                                    <div>Active Matches</div>
                                </div>
                                <div class="bg-purple-500 text-white rounded-xl p-6">
                                    <div class="text-4xl mb-2">‚úÖ</div>
                                    <div class="text-3xl font-bold">0%</div>
                                    <div>Success Rate</div>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold mb-4">All Profiles</h2>
                                <div id="profilesList">Loading...</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    await supabase.auth.signOut();
                    window.location.reload();
                });
                
                loadAllProfiles();
            }

            function showAgentPortal() {
                console.log('Showing agent portal');
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen p-6">
                        <div class="max-w-4xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-3xl font-bold">Agent Portal</h1>
                                        <p class="text-gray-600">Welcome, ${currentUserData.name}</p>
                                    </div>
                                    <button id="logoutBtnAgent" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                        Logout
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <h2 class="text-2xl font-bold mb-4">Upload Biodata</h2>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                    <div class="text-5xl mb-4">üìÑ</div>
                                    <input type="file" id="biodataFile" accept=".txt" class="hidden" />
                                    <button onclick="document.getElementById('biodataFile').click()" 
                                        class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold">
                                        Choose TXT File
                                    </button>
                                    <p class="text-sm text-gray-500 mt-2">Text files only for now</p>
                                </div>
                                <div id="uploadStatus" class="mt-4 hidden"></div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold mb-4">Your Profiles</h2>
                                <div id="agentProfiles">Loading...</div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('logoutBtnAgent').addEventListener('click', async () => {
                    await supabase.auth.signOut();
                    window.location.reload();
                });

                document.getElementById('biodataFile').addEventListener('change', handleFileUpload);
                loadAgentProfiles();
            }

            async function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const statusDiv = document.getElementById('uploadStatus');
                statusDiv.classList.remove('hidden');
                statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-700 p-3 rounded">Processing...</div>';

                try {
                    const text = await file.text();
                    const data = await extractBiodataWithAI(text);
                    
                    statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-700 p-3 rounded">Saving...</div>';
                    await saveProfile(data);
                    
                    statusDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 p-3 rounded">Success!</div>';
                    setTimeout(() => {
                        statusDiv.classList.add('hidden');
                        loadAgentProfiles();
                    }, 2000);
                } catch (error) {
                    statusDiv.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 p-3 rounded">Error: ${error.message}</div>`;
                }
            }

            async function extractBiodataWithAI(text) {
                try {
                    const response = await fetch(AI_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AI_API_KEY}`
                        },
                        body: JSON.stringify({
                            model: 'gemini-2.5-pro',
                            messages: [{ role: 'user', content: `Extract biodata and return ONLY JSON: {name, nameEng, gender, year, height, education, profession, netWorth, dowryExpectation, subCaste, location, phone}. Text: ${text}` }],
                            max_tokens: 500
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('AI API response:', data);
                    
                    // Check if response has expected structure
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('Invalid API response structure');
                    }
                    
                    const content = data.choices[0].message.content;
                    let textContent;
                    
                    // Handle different response formats
                    if (typeof content === 'string') {
                        textContent = content;
                    } else if (Array.isArray(content) && content[0] && content[0].text) {
                        textContent = content[0].text;
                    } else {
                        throw new Error('Unexpected content format');
                    }
                    
                    console.log('Extracted text:', textContent);
                    
                    const jsonMatch = textContent.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) {
                        throw new Error('No JSON found in AI response');
                    }
                    
                    return JSON.parse(jsonMatch[0]);
                } catch (error) {
                    console.error('AI extraction error:', error);
                    throw new Error(`Failed to extract biodata: ${error.message}`);
                }
            }

            async function saveProfile(data) {
                const { error } = await supabase.from('profiles').insert({
                    name: data.name,
                    name_eng: data.nameEng,
                    gender: data.gender,
                    year: data.year,
                    height: data.height,
                    education: data.education,
                    profession: data.profession,
                    net_worth: data.netWorth,
                    dowry_expectation: data.dowryExpectation,
                    sub_caste: data.subCaste,
                    location: data.location,
                    phone: data.phone,
                    agent_id: currentUser.id,
                    agent_name: currentUserData.name
                });
                if (error) throw error;
            }

            async function loadAllProfiles() {
                try {
                    const { data, error } = await supabase.from('profiles').select('*').order('created_at', { ascending: false });
                    if (error) throw error;

                    if (!data || data.length === 0) {
                        document.getElementById('profilesList').innerHTML = '<p class="text-gray-500">No profiles yet.</p>';
                        return;
                    }

                    document.getElementById('profilesList').innerHTML = data.map(p => `
                        <div class="border rounded-lg p-4 mb-4 hover:bg-gray-50">
                            <h3 class="text-xl font-bold">${p.name || 'N/A'}</h3>
                            <p class="text-sm text-gray-600">${p.gender || ''} | ${p.year || ''} | ${p.profession || ''}</p>
                            <p class="text-sm text-gray-500">${p.location || ''}</p>
                        </div>
                    `).join('');
                    document.getElementById('totalProfiles').textContent = data.length;
                } catch (error) {
                    document.getElementById('profilesList').innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
                }
            }

            async function loadAgentProfiles() {
                try {
                    const { data, error } = await supabase.from('profiles').select('*').eq('agent_id', currentUser.id);
                    if (error) throw error;

                    if (!data || data.length === 0) {
                        document.getElementById('agentProfiles').innerHTML = '<p class="text-gray-500">No profiles yet.</p>';
                        return;
                    }

                    document.getElementById('agentProfiles').innerHTML = data.map(p => `
                        <div class="border rounded-lg p-4 mb-4">
                            <h3 class="text-lg font-bold">${p.name || 'N/A'}</h3>
                            <p class="text-sm text-gray-600">${p.gender || ''} | ${p.year || ''}</p>
                        </div>
                    `).join('');
                } catch (error) {
                    document.getElementById('agentProfiles').innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
                }
            }
        }
    </script>
</body>
</html>
