<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 to-red-50 min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="text-6xl mb-4">‚è≥</div>
                <p class="text-gray-600">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        function waitForSupabase() {
            if (typeof window.supabase !== 'undefined') {
                startApp();
            } else {
                setTimeout(waitForSupabase, 100);
            }
        }
        waitForSupabase();

        function startApp() {
            const SUPABASE_URL = 'https://cmefgdiltjevddraguso.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtZWZnZGlsdGpldmRkcmFndXNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjg5NzAsImV4cCI6MjA3NDk0NDk3MH0.Cz3Acd0Qy5UR_bItqLSSn0zLoLtvvqu1WPG77-PM1RM';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            const AI_API_URL = 'https://api.euron.one/api/v1/euri/chat/completions';
            const AI_API_KEY = 'euri-806e518a3ad06e4491c2b099282bf8de3fef780b9ed1abde986b954a3c95dad6';

            let currentUser = null;
            let currentUserData = null;

            initAuth();

            async function initAuth() {
                try {
                    const sessionPromise = supabase.auth.getSession();
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), 5000)
                    );
                    
                    const { data: { session } } = await Promise.race([sessionPromise, timeoutPromise]);
                    
                    if (session) {
                        currentUser = session.user;
                        await loadUserData();
                        
                        if (currentUserData) {
                            if (currentUserData.role === 'uncle') {
                                showUncleDashboard();
                            } else if (currentUserData.role === 'agent') {
                                showAgentPortal();
                            }
                        } else {
                            showLoginPage();
                        }
                    } else {
                        showLoginPage();
                    }
                } catch (error) {
                    showLoginPage();
                }

                supabase.auth.onAuthStateChange(async (event) => {
                    if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                        window.location.reload();
                    }
                });
            }

            async function loadUserData() {
                try {
                    const { data, error } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();
                    if (error) throw error;
                    currentUserData = data;
                } catch (error) {
                    currentUserData = null;
                }
            }

            function showLoginPage() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border-4 border-orange-400">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4">üëë</div>
                                <h1 class="text-3xl font-bold text-gray-800">VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä</h1>
                                <p class="text-gray-600 mt-2">‡∞µ‡±É‡∞§‡±ç‡∞§‡∞ø‡∞™‡∞∞‡∞Æ‡±à‡∞® ‡∞™‡±Ü‡∞≥‡±ç‡∞≤‡∞ø‡∞ï‡±Ç‡∞§‡±Å‡∞∞ ‡∞µ‡±ç‡∞Ø‡∞µ‡∞∏‡±ç‡∞•</p>
                            </div>
                            
                            <form id="loginForm" class="space-y-4">
                                <input type="email" id="loginEmail" required placeholder="‡∞á‡∞Æ‡±Ü‡∞Ø‡∞ø‡∞≤‡±ç"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none" />
                                <input type="password" id="loginPassword" required placeholder="‡∞™‡∞æ‡∞∏‡±ç‡∞µ‡∞∞‡±ç‡∞°‡±ç"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none" />
                                <button type="submit"
                                    class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-3 rounded-lg font-semibold">
                                    ‡∞≤‡∞æ‡∞ó‡∞ø‡∞®‡±ç
                                </button>
                            </form>
                            
                            <div id="loginError" class="mt-4 hidden">
                                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                            </div>

                            <div class="mt-6 p-4 bg-gray-50 rounded-lg text-xs text-gray-600">
                                <p class="font-semibold mb-2">‡∞ü‡±Ü‡∞∏‡±ç‡∞ü‡±ç ‡∞ï‡±ç‡∞∞‡±Ü‡∞°‡±Ü‡∞®‡±ç‡∞∑‡∞ø‡∞Ø‡∞≤‡±ç‡∞∏‡±ç:</p>
                                <p>‡∞Ö‡∞Ç‡∞ï‡±Å‡∞≤‡±ç: uncle@reddy.com / reddy2025</p>
                                <p>‡∞è‡∞ú‡±Ü‡∞Ç‡∞ü‡±ç: agent@reddy.com / agent123</p>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value.trim();
                    const password = document.getElementById('loginPassword').value;
                    const errorDiv = document.getElementById('loginError');

                    try {
                        const { error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    } catch (error) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.querySelector('div').textContent = error.message;
                    }
                });
            }

            function showUncleDashboard() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen p-6">
                        <div class="max-w-7xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-3xl font-bold">‡∞Ö‡∞Ç‡∞ï‡±Å‡∞≤‡±ç ‡∞°‡∞æ‡∞∑‡±ç‡∞¨‡±ã‡∞∞‡±ç‡∞°‡±ç</h1>
                                        <p class="text-gray-600">‡∞∏‡±ç‡∞µ‡∞æ‡∞ó‡∞§‡∞Ç, ${currentUserData.name}</p>
                                    </div>
                                    <div class="flex gap-4">
                                        <button onclick="showMatchingView()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                            ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡∞ø‡∞Ç‡∞ó‡±ç
                                        </button>
                                        <button id="logoutBtn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                            ‡∞≤‡∞æ‡∞ó‡±ç‡∞Ö‡∞µ‡±Å‡∞ü‡±ç
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                                <div class="bg-blue-500 text-white rounded-xl p-6">
                                    <div class="text-4xl mb-2">üìä</div>
                                    <div class="text-3xl font-bold" id="totalProfiles">0</div>
                                    <div>‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç</div>
                                </div>
                                <div class="bg-green-500 text-white rounded-xl p-6">
                                    <div class="text-4xl mb-2">üéØ</div>
                                    <div class="text-3xl font-bold" id="totalMatches">0</div>
                                    <div>‡∞∏‡±Ç‡∞ö‡∞ø‡∞Ç‡∞ö‡∞ø‡∞® ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç‡∞≤‡±Å</div>
                                </div>
                                <div class="bg-purple-500 text-white rounded-xl p-6">
                                    <div class="text-4xl mb-2">‚úÖ</div>
                                    <div class="text-3xl font-bold" id="approvedMatches">0</div>
                                    <div>‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞®</div>
                                </div>
                                <div class="bg-orange-500 text-white rounded-xl p-6">
                                    <div class="text-4xl mb-2">üíë</div>
                                    <div class="text-3xl font-bold" id="successRate">0%</div>
                                    <div>‡∞µ‡∞ø‡∞ú‡∞Ø ‡∞∞‡±á‡∞ü‡±Å</div>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold mb-4">‡∞Ö‡∞®‡±ç‡∞®‡∞ø ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç</h2>
                                <div id="profilesList">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    await supabase.auth.signOut();
                });

                window.showMatchingView = showMatchingView;
                loadDashboardData();
            }

            async function loadDashboardData() {
                const { data: profiles } = await supabase.from('profiles').select('*');
                const { data: matches } = await supabase.from('matches').select('*');
                
                document.getElementById('totalProfiles').textContent = profiles?.length || 0;
                document.getElementById('totalMatches').textContent = matches?.length || 0;
                
                const approved = matches?.filter(m => m.approved_by_uncle).length || 0;
                document.getElementById('approvedMatches').textContent = approved;
                document.getElementById('successRate').textContent = 
                    matches?.length > 0 ? Math.round((approved / matches.length) * 100) + '%' : '0%';

                loadAllProfiles();
            }

            async function loadAllProfiles() {
                try {
                    const { data, error } = await supabase.from('profiles').select('*').order('created_at', { ascending: false });
                    if (error) throw error;

                    if (!data || data.length === 0) {
                        document.getElementById('profilesList').innerHTML = '<p class="text-gray-500">‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç ‡∞≤‡±á‡∞µ‡±Å</p>';
                        return;
                    }

                    document.getElementById('profilesList').innerHTML = data.map(p => `
                        <div class="border rounded-lg p-4 mb-4 hover:bg-gray-50 flex gap-4">
                            ${p.photo_url ? `
                                <div class="flex-shrink-0">
                                    <img src="${p.photo_url}" alt="Photo" class="w-32 h-32 object-cover rounded-lg" />
                                </div>
                            ` : ''}
                            <div class="flex-grow">
                                <h3 class="text-2xl font-bold text-gray-800">${p.name || 'N/A'}</h3>
                                <p class="text-lg text-gray-600 mb-2">${p.name_eng || ''}</p>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <p><span class="font-semibold">‡∞≤‡∞ø‡∞Ç‡∞ó‡∞Ç:</span> ${p.gender === 'boy' ? '‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø' : '‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø'}</p>
                                    <p><span class="font-semibold">‡∞∏‡∞Ç‡∞µ‡∞§‡±ç‡∞∏‡∞∞‡∞Ç:</span> ${p.year || 'N/A'}</p>
                                    <p><span class="font-semibold">‡∞â‡∞¶‡±ç‡∞Ø‡±ã‡∞ó‡∞Ç:</span> ${p.profession || 'N/A'}</p>
                                    <p><span class="font-semibold">VIP ‡∞∏‡±ç‡∞•‡∞æ‡∞Ø‡∞ø:</span> ${p.vip_level || 'N/A'}/5</p>
                                    <p><span class="font-semibold">‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç:</span> ${p.location || 'N/A'}</p>
                                    <p><span class="font-semibold">‡∞â‡∞™-‡∞ï‡±Å‡∞≤‡∞Ç:</span> ${p.sub_caste || 'N/A'}</p>
                                    <p><span class="font-semibold">‡∞®‡∞ø‡∞ï‡∞∞ ‡∞µ‡∞ø‡∞≤‡±Å‡∞µ:</span> ${p.net_worth || 'N/A'}</p>
                                    <p><span class="font-semibold">‡∞µ‡∞∞‡∞ï‡∞ü‡±ç‡∞®‡∞Ç:</span> ${p.dowry_expectation || 'N/A'}</p>
                                    <p><span class="font-semibold">‡∞´‡±ã‡∞®‡±ç:</span> ${p.phone || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    document.getElementById('profilesList').innerHTML = `<p class="text-red-600">‡∞≤‡±ã‡∞™‡∞Ç: ${error.message}</p>`;
                }
            }

            async function showMatchingView() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen p-6">
                        <div class="max-w-7xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <h1 class="text-3xl font-bold">‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡∞ø‡∞Ç‡∞ó‡±ç ‡∞∏‡∞ø‡∞∏‡±ç‡∞ü‡∞Æ‡±ç</h1>
                                    <button onclick="location.reload()" class="px-6 py-2 bg-gray-500 text-white rounded-lg">
                                        ‡∞µ‡±Ü‡∞®‡∞ï‡±ç‡∞ï‡∞ø
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-6">
                                <div class="bg-white rounded-2xl shadow-xl p-6">
                                    <h2 class="text-2xl font-bold mb-4">‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø‡∞≤ ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç</h2>
                                    <div id="boysList">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>
                                </div>
                                <div class="bg-white rounded-2xl shadow-xl p-6">
                                    <h2 class="text-2xl font-bold mb-4">‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø‡∞≤ ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç</h2>
                                    <div id="girlsList">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>
                                </div>
                            </div>

                            <div id="matchResults" class="mt-6"></div>
                        </div>
                    </div>
                `;

                await loadMatchingProfiles();
            }

            async function loadMatchingProfiles() {
                const { data: boys } = await supabase.from('profiles').select('*').eq('gender', 'boy');
                const { data: girls } = await supabase.from('profiles').select('*').eq('gender', 'girl');

                document.getElementById('boysList').innerHTML = (boys || []).map(b => `
                    <div class="border rounded-lg p-3 mb-3 cursor-pointer hover:bg-blue-50" onclick="findMatches('${b.id}', 'boy')">
                        <p class="font-bold">${b.name}</p>
                        <p class="text-sm text-gray-600">${b.profession} | ${b.year}</p>
                    </div>
                `).join('') || '<p class="text-gray-500">‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø‡∞≤‡±Å ‡∞≤‡±á‡∞∞‡±Å</p>';

                document.getElementById('girlsList').innerHTML = (girls || []).map(g => `
                    <div class="border rounded-lg p-3 mb-3 cursor-pointer hover:bg-pink-50" onclick="findMatches('${g.id}', 'girl')">
                        <p class="font-bold">${g.name}</p>
                        <p class="text-sm text-gray-600">${g.profession} | ${g.year}</p>
                    </div>
                `).join('') || '<p class="text-gray-500">‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø‡∞≤‡±Å ‡∞≤‡±á‡∞∞‡±Å</p>';

                window.findMatches = findMatches;
            }

            async function findMatches(profileId, gender) {
                const { data: profile } = await supabase.from('profiles').select('*').eq('id', profileId).single();
                const oppositeGender = gender === 'boy' ? 'girl' : 'boy';
                const { data: candidates } = await supabase.from('profiles').select('*').eq('gender', oppositeGender);

                if (!candidates || candidates.length === 0) {
                    document.getElementById('matchResults').innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg">
                            ${oppositeGender === 'girl' ? '‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø‡∞≤' : '‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø‡∞≤'} ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç ‡∞≤‡±á‡∞µ‡±Å
                        </div>
                    `;
                    return;
                }

                const matches = candidates.map(candidate => ({
                    candidate,
                    score: calculateMatchScore(profile, candidate),
                    reasons: getMatchReasons(profile, candidate)
                })).filter(m => m.score >= 75).sort((a, b) => b.score - a.score);

                if (matches.length === 0) {
                    document.getElementById('matchResults').innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg">
                            75% ‡∞ï‡∞Ç‡∞ü‡±á ‡∞é‡∞ï‡±ç‡∞ï‡±Å‡∞µ ‡∞∏‡±ç‡∞ï‡±ã‡∞∞‡±ç ‡∞â‡∞®‡±ç‡∞® ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç‡∞≤‡±Å ‡∞≤‡±á‡∞µ‡±Å
                        </div>
                    `;
                    return;
                }

                document.getElementById('matchResults').innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold mb-4">‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç ‡∞∏‡±Ç‡∞ö‡∞®‡∞≤‡±Å: ${profile.name}</h2>
                        ${matches.map((m, i) => `
                            <div class="border-2 ${i === 0 ? 'border-green-500' : 'border-gray-300'} rounded-lg p-6 mb-4">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-2xl font-bold">${i + 1}. ${m.candidate.name}</h3>
                                        <p class="text-gray-600">${m.candidate.name_eng}</p>
                                        <p class="text-sm text-gray-500">${m.candidate.profession} | ${m.candidate.year}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-4xl font-bold text-green-600">${m.score}%</div>
                                        <div class="text-sm text-gray-500">‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç ‡∞∏‡±ç‡∞ï‡±ã‡∞∞‡±ç</div>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                    <p class="font-semibold mb-2">‡∞é‡∞Ç‡∞¶‡±Å‡∞ï‡±Å ‡∞à ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç:</p>
                                    <ul class="space-y-1">
                                        ${m.reasons.map(r => `<li class="text-sm">‚úì ${r}</li>`).join('')}
                                    </ul>
                                </div>

                                <button onclick="approveMatch('${profile.id}', '${m.candidate.id}', ${m.score}, ${JSON.stringify(m.reasons).replace(/"/g, '&quot;')})" 
                                    class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600">
                                    ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç ‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;

                window.approveMatch = approveMatch;
            }

            function calculateMatchScore(profile1, profile2) {
                let score = 0;

                // Property/Net Worth (40 points)
                const wealth1 = parseFloat(profile1.net_worth) || 0;
                const wealth2 = parseFloat(profile2.net_worth) || 0;
                const wealthDiff = Math.abs(wealth1 - wealth2);
                if (wealthDiff < 10) score += 40;
                else if (wealthDiff < 20) score += 30;
                else if (wealthDiff < 50) score += 20;
                else score += 10;

                // Dowry compatibility (30 points)
                const dowry1 = parseFloat(profile1.dowry_expectation) || 0;
                const dowry2 = parseFloat(profile2.dowry_expectation) || 0;
                if (Math.abs(dowry1 - dowry2) < 5) score += 30;
                else if (Math.abs(dowry1 - dowry2) < 10) score += 20;
                else score += 10;

                // Age gap (15 points)
                const age1 = parseInt(profile1.year) || 0;
                const age2 = parseInt(profile2.year) || 0;
                const ageDiff = Math.abs(age1 - age2);
                if (ageDiff <= 3) score += 15;
                else if (ageDiff <= 5) score += 10;
                else if (ageDiff <= 7) score += 5;

                // Same sub-caste (10 points)
                if (profile1.sub_caste === profile2.sub_caste) score += 10;

                // Political connections (5 points)
                if (profile1.political_connections && profile2.political_connections) score += 5;

                return score;
            }

            function getMatchReasons(profile1, profile2) {
                const reasons = [];
                
                const wealth1 = parseFloat(profile1.net_worth) || 0;
                const wealth2 = parseFloat(profile2.net_worth) || 0;
                if (Math.abs(wealth1 - wealth2) < 10) {
                    reasons.push(`‡∞∏‡∞Æ‡∞æ‡∞® ‡∞Ü‡∞∏‡±ç‡∞§‡∞ø ‡∞∏‡±ç‡∞•‡∞æ‡∞Ø‡∞ø (${profile1.net_worth} ~ ${profile2.net_worth})`);
                }

                if (profile1.sub_caste === profile2.sub_caste) {
                    reasons.push(`‡∞í‡∞ï‡±á ‡∞â‡∞™-‡∞ï‡±Å‡∞≤‡∞Ç (${profile1.sub_caste})`);
                }

                const ageDiff = Math.abs(parseInt(profile1.year) - parseInt(profile2.year));
                if (ageDiff <= 5) {
                    reasons.push(`‡∞∏‡∞∞‡±à‡∞® ‡∞µ‡∞Ø‡∞∏‡±ç‡∞∏‡±Å ‡∞§‡±á‡∞°‡∞æ (${ageDiff} ‡∞∏‡∞Ç‡∞µ‡∞§‡±ç‡∞∏‡∞∞‡∞æ‡∞≤‡±Å)`);
                }

                if (profile1.profession && profile2.profession) {
                    reasons.push(`‡∞µ‡±É‡∞§‡±ç‡∞§‡∞ø: ${profile1.profession} & ${profile2.profession}`);
                }

                if (profile1.location === profile2.location) {
                    reasons.push(`‡∞í‡∞ï‡±á ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç (${profile1.location})`);
                }

                return reasons;
            }

            async function approveMatch(boyId, girlId, score, reasons) {
                try {
                    const { error } = await supabase.from('matches').insert({
                        boy_profile_id: boyId,
                        girl_profile_id: girlId,
                        match_score: score,
                        match_reasons: reasons,
                        status: 'approved',
                        approved_by_uncle: true,
                        approved_at: new Date().toISOString()
                    });

                    if (error) throw error;

                    alert('‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ö‡±ç ‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞Ü‡∞Æ‡±ã‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø! ‚úÖ');
                    location.reload();
                } catch (error) {
                    alert('‡∞≤‡±ã‡∞™‡∞Ç: ' + error.message);
                }
            }

            function showAgentPortal() {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen p-6">
                        <div class="max-w-6xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h1 class="text-3xl font-bold">‡∞è‡∞ú‡±Ü‡∞Ç‡∞ü‡±ç ‡∞™‡±ã‡∞∞‡±ç‡∞ü‡∞≤‡±ç</h1>
                                        <p class="text-gray-600">‡∞∏‡±ç‡∞µ‡∞æ‡∞ó‡∞§‡∞Ç, ${currentUserData.name}</p>
                                    </div>
                                    <button id="logoutBtnAgent" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                        ‡∞≤‡∞æ‡∞ó‡±ç‡∞Ö‡∞µ‡±Å‡∞ü‡±ç
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                                <h2 class="text-2xl font-bold mb-4">‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø</h2>
                                <form id="profileForm" class="grid grid-cols-2 gap-4">
                                    <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2">‡∞µ‡±ç‡∞Ø‡∞ï‡±ç‡∞§‡∞ø‡∞ó‡∞§ ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                    <input type="text" id="name" placeholder="‡∞™‡±á‡∞∞‡±Å (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å‡∞≤‡±ã)" required class="px-4 py-2 border rounded-lg" />
                                    <input type="text" id="nameEng" placeholder="Name (English)" required class="px-4 py-2 border rounded-lg" />
                                    <select id="gender" required class="px-4 py-2 border rounded-lg">
                                        <option value="">‡∞≤‡∞ø‡∞Ç‡∞ó‡∞Ç ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±ã‡∞Ç‡∞°‡∞ø</option>
                                        <option value="boy">‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø</option>
                                        <option value="girl">‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø</option>
                                    </select>
                                    <input type="number" id="year" placeholder="‡∞ú‡∞®‡∞®‡∞Ç ‡∞∏‡∞Ç‡∞µ‡∞§‡±ç‡∞∏‡∞∞‡∞Ç" required class="px-4 py-2 border rounded-lg" />
                                    <input type="text" id="height" placeholder="‡∞é‡∞§‡±ç‡∞§‡±Å" class="px-4 py-2 border rounded-lg" />
                                    <input type="text" id="education" placeholder="‡∞µ‡∞ø‡∞¶‡±ç‡∞Ø" class="px-4 py-2 border rounded-lg" />
                                    
                                    <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2 mt-4">VIP ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                    <input type="text" id="profession" placeholder="‡∞â‡∞¶‡±ç‡∞Ø‡±ã‡∞ó‡∞Ç" class="px-4 py-2 border rounded-lg" />
                                    <select id="vipLevel" class="px-4 py-2 border rounded-lg">
                                        <option value="">VIP ‡∞∏‡±ç‡∞•‡∞æ‡∞Ø‡∞ø</option>
                                        <option value="1">1 - ‡∞∏‡∞æ‡∞ß‡∞æ‡∞∞‡∞£‡∞Ç</option>
                                        <option value="2">2 - ‡∞Æ‡∞Ç‡∞ö‡∞ø‡∞¶‡∞ø</option>
                                        <option value="3">3 - ‡∞Ö‡∞§‡±ç‡∞Ø‡±Å‡∞§‡±ç‡∞§‡∞Æ‡∞Ç</option>
                                        <option value="4">4 - VIP</option>
                                        <option value="5">5 - ‡∞∏‡±Ç‡∞™‡∞∞‡±ç VIP</option>
                                    </select>
                                    <input type="text" id="politicalConnections" placeholder="‡∞∞‡∞æ‡∞ú‡∞ï‡±Ä‡∞Ø ‡∞∏‡∞Ç‡∞¨‡∞Ç‡∞ß‡∞æ‡∞≤‡±Å" class="px-4 py-2 border rounded-lg col-span-2" />
                                    
                                    <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2 mt-4">‡∞Ü‡∞∞‡±ç‡∞•‡∞ø‡∞ï ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                    <input type="text" id="netWorth" placeholder="‡∞®‡∞ø‡∞ï‡∞∞ ‡∞µ‡∞ø‡∞≤‡±Å‡∞µ (‡∞ï‡±ã‡∞ü‡±ç‡∞≤‡∞≤‡±ã)" class="px-4 py-2 border rounded-lg" />
                                    <input type="text" id="dowryExpectation" placeholder="‡∞µ‡∞∞‡∞ï‡∞ü‡±ç‡∞®‡∞Ç (‡∞ï‡±ã‡∞ü‡±ç‡∞≤‡∞≤‡±ã)" class="px-4 py-2 border rounded-lg" />
                                    <textarea id="propertyDetails" placeholder="‡∞Ü‡∞∏‡±ç‡∞§‡∞ø ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å" class="px-4 py-2 border rounded-lg col-span-2" rows="2"></textarea>
                                    
                                    <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2 mt-4">‡∞ï‡±Å‡∞ü‡±Å‡∞Ç‡∞¨ ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                    <input type="text" id="subCaste" placeholder="‡∞â‡∞™-‡∞ï‡±Å‡∞≤‡∞Ç" class="px-4 py-2 border rounded-lg" />
                                    <input type="text" id="fatherName" placeholder="‡∞§‡∞Ç‡∞°‡±ç‡∞∞‡∞ø ‡∞™‡±á‡∞∞‡±Å" class="px-4 py-2 border rounded-lg" />
                                    <input type="text" id="motherName" placeholder="‡∞§‡∞≤‡±ç‡∞≤‡∞ø ‡∞™‡±á‡∞∞‡±Å" class="px-4 py-2 border rounded-lg" />
                                    <input type="number" id="siblingsCount" placeholder="‡∞§‡±ã‡∞¨‡±Å‡∞ü‡±ç‡∞ü‡±Å‡∞µ‡±Å‡∞≤ ‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø" class="px-4 py-2 border rounded-lg" />
                                    
                                    <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2 mt-4">‡∞∏‡±ç‡∞•‡∞æ‡∞® ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                    <input type="text" id="location" placeholder="‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§ ‡∞®‡∞ó‡∞∞‡∞Ç" class="px-4 py-2 border rounded-lg" />
                                    <input type="text" id="nativePlace" placeholder="‡∞∏‡±ç‡∞µ‡∞∏‡±ç‡∞•‡∞≤‡∞Ç" class="px-4 py-2 border rounded-lg" />
                                    
                                    <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2 mt-4">‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞™‡±Å ‡∞∏‡∞Æ‡∞æ‡∞ö‡∞æ‡∞∞‡∞Ç</h3></div>
                                    <input type="tel" id="phone" placeholder="‡∞´‡±ã‡∞®‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç" required class="px-4 py-2 border rounded-lg" />
                                    <input type="tel" id="whatsapp" placeholder="‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞™‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç" class="px-4 py-2 border rounded-lg" />
                                    
                                    <div class="col-span-2"><h3 class="font-bold text-lg border-b pb-2 mt-4">‡∞´‡±ã‡∞ü‡±ã</h3></div>
                                    <input type="file" id="photoFile" accept="image/*" class="col-span-2" />
                                    <div id="photoPreview" class="col-span-2 hidden mt-2">
                                        <img id="previewImg" class="max-h-40 rounded-lg" />
                                    </div>
                                    
                                    <button type="submit" class="col-span-2 mt-4 bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600">
                                        ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç ‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø
                                    </button>
                                </form>
                                <div id="saveStatus" class="mt-4 hidden"></div>
                            </div>

                            <div class="bg-white rounded-2xl shadow-xl p-6">
                                <h2 class="text-2xl font-bold mb-4">‡∞Æ‡±Ä ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç</h2>
                                <div id="agentProfiles">‡∞≤‡±ã‡∞°‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('logoutBtnAgent').addEventListener('click', async () => {
                    await supabase.auth.signOut();
                });

                document.getElementById('photoFile').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            document.getElementById('previewImg').src = e.target.result;
                            document.getElementById('photoPreview').classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });

                document.getElementById('profileForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const statusDiv = document.getElementById('saveStatus');
                    statusDiv.classList.remove('hidden');
                    statusDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-700 p-3 rounded">‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...</div>';

                    try {
                        let photoUrl = null;
                        const photoFile = document.getElementById('photoFile').files[0];
                        if (photoFile) {
                            photoUrl = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = () => resolve(reader.result);
                                reader.readAsDataURL(photoFile);
                            });
                        }

                        const profileData = {
                            name: document.getElementById('name').value,
                            name_eng: document.getElementById('nameEng').value,
                            gender: document.getElementById('gender').value,
                            year: document.getElementById('year').value,
                            height: document.getElementById('height').value,
                            education: document.getElementById('education').value,
                            profession: document.getElementById('profession').value,
                            vip_level: document.getElementById('vipLevel').value,
                            political_connections: document.getElementById('politicalConnections').value,
                            net_worth: document.getElementById('netWorth').value,
                            dowry_expectation: document.getElementById('dowryExpectation').value,
                            property_details: document.getElementById('propertyDetails').value,
                            sub_caste: document.getElementById('subCaste').value,
                            father_name: document.getElementById('fatherName').value,
                            mother_name: document.getElementById('motherName').value,
                            siblings_count: document.getElementById('siblingsCount').value,
                            location: document.getElementById('location').value,
                            native_place: document.getElementById('nativePlace').value,
                            phone: document.getElementById('phone').value,
                            whatsapp: document.getElementById('whatsapp').value,
                            photo_url: photoUrl,
                            agent_id: currentUser.id,
                            agent_name: currentUserData.name,
                            status: 'active'
                        };

                        const { error } = await supabase.from('profiles').insert(profileData);
                        if (error) throw error;

                        statusDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-700 p-3 rounded">‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞∏‡±á‡∞µ‡±ç ‡∞ö‡±á‡∞Ø‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø!</div>';
                        document.getElementById('profileForm').reset();
                        document.getElementById('photoPreview').classList.add('hidden');
                        
                        setTimeout(() => {
                            statusDiv.classList.add('hidden');
                            loadAgentProfiles();
                        }, 2000);
                    } catch (error) {
                        statusDiv.innerHTML = `<div class="bg-red-50 border border-red-200 text-red-700 p-3 rounded">‡∞≤‡±ã‡∞™‡∞Ç: ${error.message}</div>`;
                    }
                });

                loadAgentProfiles();
            }

            async function loadAgentProfiles() {
                try {
                    const { data, error } = await supabase.from('profiles').select('*').eq('agent_id', currentUser.id);
                    if (error) throw error;

                    if (!data || data.length === 0) {
                        document.getElementById('agentProfiles').innerHTML = '<p class="text-gray-500">‡∞Æ‡±Ä‡∞∞‡±Å ‡∞á‡∞Ç‡∞ï‡∞æ ‡∞™‡±ç‡∞∞‡±ä‡∞´‡±à‡∞≤‡±ç‡∞∏‡±ç ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞≤‡±á‡∞¶‡±Å</p>';
                        return;
                    }

                    document.getElementById('agentProfiles').innerHTML = data.map(p => `
                        <div class="border rounded-lg p-4 mb-4 flex gap-4">
                            ${p.photo_url ? `<img src="${p.photo_url}" class="w-24 h-24 object-cover rounded-lg" />` : ''}
                            <div>
                                <h3 class="text-lg font-bold">${p.name}</h3>
                                <p class="text-sm text-gray-600">${p.gender === 'boy' ? '‡∞Ö‡∞¨‡±ç‡∞¨‡∞æ‡∞Ø‡∞ø' : '‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞æ‡∞Ø‡∞ø'} | ${p.year} | ${p.profession}</p>
                                <p class="text-sm text-gray-500">${p.location}</p>
                            </div>
                        </div>
                    `).join('');
                } catch (error) {
                    document.getElementById('agentProfiles').innerHTML = `<p class="text-red-600">‡∞≤‡±ã‡∞™‡∞Ç: ${error.message}</p>`;
                }
            }
        }
    </script>
</body>
</html>
