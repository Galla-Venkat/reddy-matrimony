<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 to-red-50 min-h-screen">
    <div id="app"></div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://cmefgdiltjevddraguso.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtZWZnZGlsdGpldmRkcmFndXNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNjg5NzAsImV4cCI6MjA3NDk0NDk3MH0.Cz3Acd0Qy5UR_bItqLSSn0zLoLtvvqu1WPG77-PM1RM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // AI API Configuration
        const AI_API_URL = 'https://api.euron.one/api/v1/euri/chat/completions';
        const AI_API_KEY = 'euri-806e518a3ad06e4491c2b099282bf8de3fef780b9ed1abde986b954a3c95dad6';

        // Global state
        let currentUser = null;
        let currentUserData = null;

        // Check auth state on load
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                currentUser = session.user;
                await loadUserData();
                if (currentUserData) {
                    if (currentUserData.role === 'uncle') {
                        showUncleDashboard();
                    } else if (currentUserData.role === 'agent') {
                        showAgentPortal();
                    }
                } else {
                    showLoginPage();
                    alert('User profile not found. Please contact admin.');
                }
            } else {
                currentUser = null;
                currentUserData = null;
                showLoginPage();
            }
        });

        async function loadUserData() {
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;
                currentUserData = data;
                console.log('User data loaded:', currentUserData);
            } catch (error) {
                console.error('Error loading user data:', error);
                currentUserData = null;
            }
        }

        function showLoginPage() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border-4 border-orange-400">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üëë</div>
                            <h1 class="text-3xl font-bold text-gray-800">VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä</h1>
                            <p class="text-gray-600 mt-2">Professional Matchmaking System</p>
                        </div>
                        
                        <div class="space-y-4">
                            <input 
                                type="email" 
                                id="loginEmail" 
                                placeholder="Email"
                                value=""
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            />
                            <input 
                                type="password" 
                                id="loginPassword" 
                                placeholder="Password"
                                value=""
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            />
                            <button 
                                id="loginBtn"
                                class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-3 rounded-lg font-semibold hover:from-red-700 hover:to-orange-700 transition"
                            >
                                Login
                            </button>
                        </div>
                        
                        <div id="loginError" class="mt-4 hidden">
                            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                        </div>

                        <div class="mt-6 p-4 bg-gray-50 rounded-lg text-xs text-gray-600">
                            <p class="font-semibold mb-2">Test Credentials:</p>
                            <p>Uncle: uncle@reddy.com / reddy2025</p>
                            <p>Agent: agent@reddy.com / agent123</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('loginEmail').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!email || !password) {
                errorDiv.classList.remove('hidden');
                errorDiv.querySelector('div').textContent = 'Please enter both email and password';
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;
                errorDiv.classList.add('hidden');
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.classList.remove('hidden');
                errorDiv.querySelector('div').textContent = `Login failed: ${error.message}`;
            }
        }

        function showUncleDashboard() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen p-6">
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800">Uncle Dashboard</h1>
                                    <p class="text-gray-600">Welcome, ${currentUserData.name}</p>
                                </div>
                                <button id="logoutBtn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    Logout
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6">
                                <div class="text-4xl mb-2">üìä</div>
                                <div class="text-3xl font-bold" id="totalProfiles">0</div>
                                <div class="text-blue-100">Total Profiles</div>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6">
                                <div class="text-4xl mb-2">üéØ</div>
                                <div class="text-3xl font-bold">0</div>
                                <div class="text-green-100">Active Matches</div>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6">
                                <div class="text-4xl mb-2">‚úÖ</div>
                                <div class="text-3xl font-bold">0%</div>
                                <div class="text-purple-100">Success Rate</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">All Profiles</h2>
                            <div id="profilesList" class="text-gray-600">
                                Loading profiles...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            loadAllProfiles();
        }

        function showAgentPortal() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen p-6">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800">Agent Portal</h1>
                                    <p class="text-gray-600">Welcome, ${currentUserData.name}</p>
                                </div>
                                <button id="logoutBtn" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    Logout
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Upload Biodata</h2>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                <div class="text-5xl mb-4">üìÑ</div>
                                <input 
                                    type="file" 
                                    id="biodataFile" 
                                    accept=".pdf,.txt"
                                    class="hidden"
                                />
                                <button 
                                    id="uploadBtn"
                                    class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold"
                                >
                                    Choose File to Upload
                                </button>
                                <p class="text-sm text-gray-500 mt-2">PDF or TXT files supported</p>
                            </div>
                            <div id="uploadStatus" class="mt-4 hidden">
                                <div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg"></div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Profiles</h2>
                            <div id="agentProfiles" class="text-gray-600">
                                Loading your profiles...
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('uploadBtn').addEventListener('click', () => {
                document.getElementById('biodataFile').click();
            });
            document.getElementById('biodataFile').addEventListener('change', handleFileUpload);
            
            loadAgentProfiles();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.classList.remove('hidden');
            statusDiv.querySelector('div').className = 'bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg';
            statusDiv.querySelector('div').textContent = 'Processing file with AI...';

            try {
                const text = await file.text();
                const extractedData = await extractBiodataWithAI(text);
                
                statusDiv.querySelector('div').textContent = 'Saving profile...';
                await saveProfile(extractedData);
                
                statusDiv.querySelector('div').className = 'bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg';
                statusDiv.querySelector('div').textContent = 'Profile added successfully!';
                
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                    loadAgentProfiles();
                }, 2000);
            } catch (error) {
                console.error('Upload error:', error);
                statusDiv.querySelector('div').className = 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg';
                statusDiv.querySelector('div').textContent = `Error: ${error.message}`;
            }
        }

        async function extractBiodataWithAI(text) {
            const response = await fetch(AI_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AI_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gemini-2.5-pro',
                    messages: [{
                        role: 'user',
                        content: `Extract biodata from this text. Return ONLY valid JSON with these fields: name, nameEng, gender, year, height, education, profession, netWorth, dowryExpectation, subCaste, location, phone. Text: ${text}`
                    }],
                    max_tokens: 1000,
                    temperature: 0.3
                })
            });

            const data = await response.json();
            const content = data.choices[0].message.content[0].text;
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            return jsonMatch ? JSON.parse(jsonMatch[0]) : JSON.parse(content);
        }

        async function saveProfile(data) {
            const { error } = await supabase.from('profiles').insert({
                name: data.name,
                name_eng: data.nameEng,
                gender: data.gender,
                year: data.year,
                height: data.height,
                education: data.education,
                profession: data.profession,
                net_worth: data.netWorth,
                dowry_expectation: data.dowryExpectation,
                sub_caste: data.subCaste,
                location: data.location,
                phone: data.phone,
                agent_id: currentUser.id,
                agent_name: currentUserData.name,
                status: 'active',
                approved_by_uncle: false
            });

            if (error) throw error;
        }

        async function loadAllProfiles() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    document.getElementById('profilesList').innerHTML = '<p class="text-gray-500">No profiles yet.</p>';
                    return;
                }

                const profilesHtml = data.map(profile => `
                    <div class="border rounded-lg p-4 mb-4 hover:bg-gray-50">
                        <div class="flex justify-between">
                            <div>
                                <h3 class="text-xl font-bold">${profile.name || 'N/A'}</h3>
                                <p class="text-sm text-gray-600">${profile.gender || 'N/A'} | ${profile.year || 'N/A'} | ${profile.profession || 'N/A'}</p>
                                <p class="text-sm text-gray-500">${profile.location || 'N/A'}</p>
                            </div>
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm h-fit">${profile.status}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('profilesList').innerHTML = profilesHtml;
                document.getElementById('totalProfiles').textContent = data.length;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('profilesList').innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
            }
        }

        async function loadAgentProfiles() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('agent_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    document.getElementById('agentProfiles').innerHTML = '<p class="text-gray-500">No profiles yet.</p>';
                    return;
                }

                const profilesHtml = data.map(profile => `
                    <div class="border rounded-lg p-4 mb-4">
                        <h3 class="text-lg font-bold">${profile.name || 'N/A'}</h3>
                        <p class="text-sm text-gray-600">${profile.gender || 'N/A'} | ${profile.year || 'N/A'}</p>
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs mt-2 inline-block">${profile.status}</span>
                    </div>
                `).join('');

                document.getElementById('agentProfiles').innerHTML = profilesHtml;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('agentProfiles').innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
        }
    </script>
</body>
</html>
