<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 to-red-50 min-h-screen">
    <div id="app"></div>

    <!-- Firebase Scripts - Version 9 modular -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, query, where, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBFtdrjavkNXgFZKJUY309d88oRkGTmfKU",
            authDomain: "reddy-matrimony.firebaseapp.com",
            projectId: "reddy-matrimony",
            storageBucket: "reddy-matrimony.firebasestorage.app",
            messagingSenderId: "746200669417",
            appId: "1:746200669417:web:6d74aa8c21ee636c6de478"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Store globally for access
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.firebaseSignOut = signOut;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseOrderBy = orderBy;
        window.firebaseServerTimestamp = serverTimestamp;

        console.log('Firebase initialized successfully');

        // Start the app after Firebase is ready
        startApp();
    </script>

    <script>
        // Global state
        let currentUser = null;
        let currentUserData = null;
        let profiles = [];
        let matches = [];

        // Third-party AI API configuration
        const AI_API_URL = 'https://api.euron.one/api/v1/euri/chat/completions';
        const AI_API_KEY = 'euri-806e518a3ad06e4491c2b099282bf8de3fef780b9ed1abde986b954a3c95dad6';

        function startApp() {
            // Check auth state
            window.firebaseOnAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData();
                    if (currentUserData) {
                        if (currentUserData.role === 'uncle') {
                            showUncleDashboard();
                        } else if (currentUserData.role === 'agent') {
                            showAgentPortal();
                        }
                    }
                } else {
                    showLoginPage();
                }
            });
        }

        async function loadUserData() {
            try {
                const userDoc = await window.firebaseGetDoc(
                    window.firebaseDoc(window.firebaseDb, 'users', currentUser.uid)
                );
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    console.log('User data loaded:', currentUserData);
                } else {
                    console.error('No user document found');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function showLoginPage() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border-4 border-orange-400">
                        <div class="text-center mb-8">
                            <div class="text-6xl mb-4">üëë</div>
                            <h1 class="text-3xl font-bold text-gray-800">VIP ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞ü‡±ç‡∞∞‡∞ø‡∞Æ‡±ã‡∞®‡±Ä</h1>
                            <p class="text-gray-600 mt-2">Professional Matchmaking System</p>
                            <p class="text-sm text-gray-500 mt-1">Uncle & Agent Login</p>
                        </div>
                        
                        <div class="space-y-4">
                            <input 
                                type="email" 
                                id="loginEmail" 
                                placeholder="Email"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            />
                            <input 
                                type="password" 
                                id="loginPassword" 
                                placeholder="Password"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            />
                            <button 
                                onclick="handleLogin()"
                                class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-3 rounded-lg font-semibold hover:from-red-700 hover:to-orange-700 transition"
                            >
                                Login
                            </button>
                        </div>
                        
                        <div id="loginError" class="mt-4 hidden">
                            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                        </div>

                        <div class="mt-6 p-4 bg-gray-50 rounded-lg text-xs text-gray-600">
                            <p class="font-semibold mb-2">Test Credentials:</p>
                            <p>Uncle: uncle@reddy.com / reddy2025</p>
                            <p>Agent: agent@reddy.com / agent123</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                await window.firebaseSignIn(window.firebaseAuth, email, password);
                errorDiv.classList.add('hidden');
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.classList.remove('hidden');
                errorDiv.querySelector('div').textContent = `Login failed: ${error.message}`;
            }
        }

        function showUncleDashboard() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen p-6">
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800">Uncle Dashboard</h1>
                                    <p class="text-gray-600">Welcome, ${currentUserData.name}</p>
                                </div>
                                <button onclick="handleLogout()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    Logout
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6">
                                <div class="text-4xl mb-2">üìä</div>
                                <div class="text-3xl font-bold">0</div>
                                <div class="text-blue-100">Total Profiles</div>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6">
                                <div class="text-4xl mb-2">üéØ</div>
                                <div class="text-3xl font-bold">0</div>
                                <div class="text-green-100">Active Matches</div>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6">
                                <div class="text-4xl mb-2">‚úÖ</div>
                                <div class="text-3xl font-bold">0</div>
                                <div class="text-purple-100">Success Rate</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">All Profiles</h2>
                            <div id="profilesList" class="text-gray-600">
                                Loading profiles...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            loadAllProfiles();
        }

        function showAgentPortal() {
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen p-6">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800">Agent Portal</h1>
                                    <p class="text-gray-600">Welcome, ${currentUserData.name}</p>
                                </div>
                                <button onclick="handleLogout()" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    Logout
                                </button>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Upload Biodata</h2>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                <div class="text-5xl mb-4">üìÑ</div>
                                <input 
                                    type="file" 
                                    id="biodataFile" 
                                    accept=".pdf,.txt"
                                    class="hidden"
                                    onchange="handleFileUpload(event)"
                                />
                                <button 
                                    onclick="document.getElementById('biodataFile').click()"
                                    class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold"
                                >
                                    Choose File to Upload
                                </button>
                                <p class="text-sm text-gray-500 mt-2">PDF or TXT files supported</p>
                            </div>
                            <div id="uploadStatus" class="mt-4 hidden">
                                <div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg"></div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Profiles</h2>
                            <div id="agentProfiles" class="text-gray-600">
                                Loading your profiles...
                            </div>
                        </div>
                    </div>
                </div>
            `;
            loadAgentProfiles();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.classList.remove('hidden');
            statusDiv.querySelector('div').textContent = 'Processing file with AI...';

            try {
                const text = await file.text();
                const extractedData = await extractBiodataWithAI(text);
                
                statusDiv.querySelector('div').textContent = 'Saving profile...';
                await saveProfile(extractedData);
                
                statusDiv.querySelector('div').className = 'bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg';
                statusDiv.querySelector('div').textContent = 'Profile added successfully!';
                
                setTimeout(() => {
                    loadAgentProfiles();
                }, 1500);
            } catch (error) {
                console.error('Upload error:', error);
                statusDiv.querySelector('div').className = 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg';
                statusDiv.querySelector('div').textContent = `Error: ${error.message}`;
            }
        }

        async function extractBiodataWithAI(text) {
            const response = await fetch(AI_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${AI_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gemini-2.5-pro',
                    messages: [{
                        role: 'user',
                        content: `Extract biodata information from this text and return ONLY a valid JSON object with these exact fields:
{
  "name": "name in Telugu",
  "nameEng": "name in English",
  "gender": "boy or girl",
  "year": "birth year",
  "height": "height",
  "education": "education details",
  "profession": "profession",
  "netWorth": "net worth in Telugu",
  "dowryExpectation": "dowry expectation or capacity",
  "subCaste": "sub-caste in Telugu",
  "location": "current city",
  "phone": "phone number"
}

Text: ${text}

Return ONLY the JSON, no other text.`
                    }],
                    max_tokens: 1000,
                    temperature: 0.3
                })
            });

            const data = await response.json();
            const content = data.choices[0].message.content[0].text;
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            return jsonMatch ? JSON.parse(jsonMatch[0]) : JSON.parse(content);
        }

        async function saveProfile(data) {
            await window.firebaseAddDoc(window.firebaseCollection(window.firebaseDb, 'profiles'), {
                ...data,
                agentId: currentUser.uid,
                agentName: currentUserData.name,
                status: 'active',
                approvedByUncle: false,
                createdAt: window.firebaseServerTimestamp(),
                updatedAt: window.firebaseServerTimestamp()
            });
        }

        async function loadAllProfiles() {
            try {
                const querySnapshot = await window.firebaseGetDocs(
                    window.firebaseCollection(window.firebaseDb, 'profiles')
                );
                
                const profilesHtml = querySnapshot.empty ? 
                    '<p class="text-gray-500">No profiles yet. Agents will add profiles soon.</p>' :
                    querySnapshot.docs.map(doc => {
                        const data = doc.data();
                        return `
                            <div class="border rounded-lg p-4 mb-4 hover:bg-gray-50">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">${data.name}</h3>
                                        <p class="text-gray-600">${data.nameEng || ''}</p>
                                        <p class="text-sm text-gray-500 mt-2">
                                            ${data.gender} | ${data.year} | ${data.profession || 'N/A'}
                                        </p>
                                        <p class="text-sm text-gray-500">
                                            ${data.location || 'N/A'} | ${data.subCaste || 'N/A'}
                                        </p>
                                    </div>
                                    <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
                                        ${data.status}
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('');

                document.getElementById('profilesList').innerHTML = profilesHtml;
            } catch (error) {
                console.error('Error loading profiles:', error);
                document.getElementById('profilesList').innerHTML = 
                    `<p class="text-red-600">Error loading profiles: ${error.message}</p>`;
            }
        }

        async function loadAgentProfiles() {
            try {
                const q = window.firebaseQuery(
                    window.firebaseCollection(window.firebaseDb, 'profiles'),
                    window.firebaseWhere('agentId', '==', currentUser.uid)
                );
                const querySnapshot = await window.firebaseGetDocs(q);
                
                const profilesHtml = querySnapshot.empty ? 
                    '<p class="text-gray-500">You haven\'t added any profiles yet.</p>' :
                    querySnapshot.docs.map(doc => {
                        const data = doc.data();
                        return `
                            <div class="border rounded-lg p-4 mb-4 hover:bg-gray-50">
                                <h3 class="text-lg font-bold text-gray-800">${data.name}</h3>
                                <p class="text-gray-600">${data.nameEng || ''}</p>
                                <p class="text-sm text-gray-500 mt-2">
                                    ${data.gender} | ${data.year} | ${data.profession || 'N/A'}
                                </p>
                                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs mt-2 inline-block">
                                    ${data.status}
                                </span>
                            </div>
                        `;
                    }).join('');

                document.getElementById('agentProfiles').innerHTML = profilesHtml;
            } catch (error) {
                console.error('Error loading agent profiles:', error);
                document.getElementById('agentProfiles').innerHTML = 
                    `<p class="text-red-600">Error: ${error.message}</p>`;
            }
        }

        async function handleLogout() {
            await window.firebaseSignOut(window.firebaseAuth);
        }
    </script>
</body>
</html>
